<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assignment Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary-green: #1b5e20;
      --secondary-green: #2e7d32;
      --light-green: #e8f5e9;
      --danger-red: #b71c1c;
      --warning-orange: #ff9800;
      --text-muted: #666;
    }
    
    body {
      background: linear-gradient(135deg, #f8f9fa, #e8f5e9);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .card {
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }
    
    .status-badge {
      font-size: 0.9rem;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 500;
    }
    
    .assignment-header {
      background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
      color: white;
      border-radius: 12px 12px 0 0;
      padding: 1.5rem;
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    }
    
    .info-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .file-upload-area {
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s;
      background: #fafafa;
    }
    
    .file-upload-area.dragover {
      border-color: var(--secondary-green);
      background: var(--light-green);
    }
    
    .file-upload-area:hover {
      border-color: var(--secondary-green);
    }
    
    .submission-timeline {
      position: relative;
      padding-left: 30px;
    }
    
    .submission-timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--secondary-green);
    }
    
    .timeline-item {
      position: relative;
      margin-bottom: 20px;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--secondary-green);
    }
    
    .countdown {
      font-size: 1.1rem;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 20px;
      display: inline-block;
    }
    
    .countdown.urgent {
      background: #ffebee;
      color: var(--danger-red);
      animation: pulse 2s infinite;
    }
    
    .countdown.warning {
      background: #fff3e0;
      color: var(--warning-orange);
    }
    
    .countdown.normal {
      background: var(--light-green);
      color: var(--primary-green);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .loading-spinner {
      display: flex;
      justify-content: center;
      padding: 3rem;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--secondary-green);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .notification.error {
      background: var(--danger-red);
    }
    
    .grade-display {
      font-size: 1.5rem;
      font-weight: bold;
      padding: 10px 20px;
      border-radius: 10px;
      text-align: center;
      margin: 10px 0;
    }
    
    .grade-pass {
      background: var(--light-green);
      color: var(--primary-green);
    }
    
    .grade-fail {
      background: #ffebee;
      color: var(--danger-red);
    }
    
    .file-preview {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    
    @media (max-width: 768px) {
      .assignment-header {
        padding: 1rem;
        margin: -1rem -1rem 1rem -1rem;
      }
      
      .card {
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="student-dashboard.html" class="text-decoration-none"><i class="bi bi-arrow-left"></i> Back to Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page" id="breadcrumbTitle">Assignment Details</li>
      </ol>
    </nav>
    
    <div id="assignmentCard" class="card shadow-sm p-4">
      <div id="assignmentHeader" class="assignment-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
          <div>
            <h2 id="assignmentTitle" class="mb-2">Loading assignment...</h2>
            <div id="countdown" class="countdown mt-2"></div>
          </div>
          <div id="statusBadge" class="status-badge bg-light text-dark mt-2 mt-md-0"></div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-8">
          <div class="info-section">
            <h5 class="mb-3"><i class="bi bi-info-circle"></i> Assignment Information</h5>
            <div class="info-item">
              <strong><i class="bi bi-book"></i> Course:</strong> <span id="course"></span>
            </div>
            <div class="info-item">
              <strong><i class="bi bi-card-text"></i> Description:</strong> 
              <div id="description" class="mt-1 p-3 bg-light rounded"></div>
            </div>
            <div class="info-item">
              <strong><i class="bi bi-calendar-event"></i> Deadline:</strong> <span id="deadline"></span>
            </div>
            <div class="info-item">
              <strong><i class="bi bi-clock"></i> Time Remaining:</strong> <span id="timeRemaining"></span>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="info-section">
            <h5 class="mb-3"><i class="bi bi-upload"></i> Submission</h5>
            <div id="submissionSection">
              <div class="loading-spinner">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="submissionHistory" class="mt-4" style="display: none;">
        <h5><i class="bi bi-clock-history"></i> Submission History</h5>
        <div class="submission-timeline mt-3" id="timelineContainer"></div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification">
    <i class="bi bi-check-circle"></i>
    <span id="notificationText">Operation completed successfully</span>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
      authDomain: "lecturer-student-project.firebaseapp.com",
      projectId: "lecturer-student-project",
      storageBucket: "lecturer-student-project.appspot.com",
      messagingSenderId: "266517931898",
      appId: "1:266517931898:web:f48b4af12fdc81001058c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Supabase Config
    const SUPABASE_URL = "https://jkbbxyxpvwyrwuscujwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprYmJ4eXhwdnd5cnd1c2N1andqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzg5MjUsImV4cCI6MjA3MzgxNDkyNX0.aTcdR870dKn5bXMDm06wrCDnp7usG8qcU-BaS81ubP4";
    const BUCKET_NAME = "Lecturer-Student Storage";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM Elements
    const assignmentTitleEl = document.getElementById("assignmentTitle");
    const breadcrumbTitleEl = document.getElementById("breadcrumbTitle");
    const courseEl = document.getElementById("course");
    const descriptionEl = document.getElementById("description");
    const deadlineEl = document.getElementById("deadline");
    const timeRemainingEl = document.getElementById("timeRemaining");
    const statusBadgeEl = document.getElementById("statusBadge");
    const submissionSection = document.getElementById("submissionSection");
    const submissionHistory = document.getElementById("submissionHistory");
    const timelineContainer = document.getElementById("timelineContainer");
    const countdownEl = document.getElementById("countdown");
    const notificationEl = document.getElementById("notification");
    const notificationTextEl = document.getElementById("notificationText");

    // Helper functions
    function showNotification(message, isError = false) {
      notificationTextEl.textContent = message;
      notificationEl.className = 'notification' + (isError ? ' error' : '');
      notificationEl.classList.add('show');
      
      setTimeout(() => {
        notificationEl.classList.remove('show');
      }, 4000);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        pdf: 'bi-file-pdf',
        doc: 'bi-file-word',
        docx: 'bi-file-word',
        txt: 'bi-file-text',
        zip: 'bi-file-zip',
        rar: 'bi-file-zip',
        ppt: 'bi-file-ppt',
        pptx: 'bi-file-ppt',
        xls: 'bi-file-excel',
        xlsx: 'bi-file-excel',
        jpg: 'bi-file-image',
        jpeg: 'bi-file-image',
        png: 'bi-file-image',
        gif: 'bi-file-image'
      };
      return icons[ext] || 'bi-file-earmark';
    }

    function updateCountdown(deadline) {
      if (!deadline) return;
      
      const now = new Date();
      const timeDiff = deadline - now;
      
      if (timeDiff <= 0) {
        countdownEl.textContent = "Deadline passed";
        countdownEl.className = "countdown urgent";
        return;
      }
      
      const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
      
      let countdownText = "";
      if (days > 0) {
        countdownText = `${days}d ${hours}h ${minutes}m`;
        countdownEl.className = days <= 1 ? "countdown warning" : "countdown normal";
      } else if (hours > 0) {
        countdownText = `${hours}h ${minutes}m`;
        countdownEl.className = "countdown warning";
      } else {
        countdownText = `${minutes}m`;
        countdownEl.className = "countdown urgent";
      }
      
      countdownEl.textContent = countdownText;
      timeRemainingEl.textContent = countdownText;
    }

    // Get assignment ID
    const urlParams = new URLSearchParams(window.location.search);
    const assignmentId = urlParams.get("id");

    if (!assignmentId) {
      showNotification("No assignment specified", true);
      setTimeout(() => window.location.href = "assignments.html", 2000);
    }

    // Auth listener
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        // Check user role first
        const userRef = await db.collection("users").doc(user.uid).get();
        if (!userRef.exists) {
          showNotification("User profile not found.", true);
          setTimeout(() => window.location.href = "login.html", 2000);
          return;
        }

        const userData = userRef.data();
        if (userData.role !== "student") {
          showNotification("Access denied. Only students can view this page.", true);
          setTimeout(() => window.location.href = "index.html", 2000);
          return;
        }

        // Fetch assignment details
        const assignmentRef = db.collection("assignments").doc(assignmentId);
        const assignmentSnap = await assignmentRef.get();

        if (!assignmentSnap.exists) {
          assignmentTitleEl.textContent = "Assignment not found.";
          showNotification("Assignment not found", true);
          return;
        }

        const data = assignmentSnap.data();
        const deadline = data.deadline?.toDate?.() || null;
        const now = new Date();

        // Update UI with assignment data
        assignmentTitleEl.textContent = data.assignmentTitle || "Untitled Assignment";
        breadcrumbTitleEl.textContent = data.assignmentTitle || "Assignment Details";
        courseEl.textContent = `${data.courseCode || ""} - ${data.courseTitle || ""}`;
        descriptionEl.textContent = data.description || "No description provided.";
        deadlineEl.textContent = deadline ? deadline.toLocaleString() : "No deadline";

        // Start countdown timer if deadline exists
        if (deadline) {
          updateCountdown(deadline);
          setInterval(() => updateCountdown(deadline), 60000); // Update every minute
        }

        let status = "Pending Submission";
        let badgeClass = "bg-warning";

        // Check submission for this assignment
        const submissionQuery = await db.collection("submissions")
          .where("assignmentId", "==", assignmentId)
          .where("studentId", "==", user.uid)
          .orderBy("submittedAt", "desc")
          .get();

        const submissions = submissionQuery.docs;
        const latestSubmission = submissions[0];

        if (latestSubmission) {
          const subData = latestSubmission.data();
          const graded = subData.grade !== null && subData.grade !== undefined;
          const submittedAt = subData.submittedAt?.toDate?.()?.toLocaleString() || "N/A";
          const fileURL = subData.fileURL || "#";
          const fileName = subData.fileName || "Submission file";
          const fileSize = subData.fileSize || 0;
          const grade = subData.grade;
          const feedback = subData.feedback || "";

          if (graded) {
            if (grade >= 50) {
              status = `Graded – Passed (${grade}%)`;
              badgeClass = "bg-success";
            } else {
              status = `Graded – Failed (${grade}%)`;
              badgeClass = "bg-danger";
            }
          } else {
            status = "Submitted (Awaiting Grade)";
            badgeClass = "bg-primary";
          }

          statusBadgeEl.innerHTML = `<span class="status-badge ${badgeClass} text-white">${status}</span>`;

          // Show submission details
          let submissionHTML = `
            <div class="file-preview">
              <div class="d-flex align-items-center">
                <i class="${getFileIcon(fileName)} me-2 fs-4 text-primary"></i>
                <div class="flex-grow-1">
                  <div class="fw-bold">${fileName}</div>
                  <div class="small text-muted">${formatFileSize(fileSize)} • Submitted: ${submittedAt}</div>
                </div>
                <a href="${fileURL}" target="_blank" class="btn btn-sm btn-outline-success ms-2">
                  <i class="bi bi-download"></i> Download
                </a>
              </div>
            </div>
          `;

          if (graded) {
            submissionHTML += `
              <div class="grade-display ${grade >= 50 ? 'grade-pass' : 'grade-fail'} mt-3">
                Grade: ${grade}%
              </div>
              ${feedback ? `
                <div class="mt-3">
                  <strong>Feedback:</strong>
                  <div class="p-3 bg-light rounded mt-1">${feedback}</div>
                </div>
              ` : ''}
            `;
          }

          submissionSection.innerHTML = submissionHTML;

          // Show submission history if multiple submissions
          if (submissions.length > 1) {
            submissionHistory.style.display = 'block';
            let timelineHTML = '';
            
            submissions.forEach((doc, index) => {
              const sub = doc.data();
              const submittedAt = sub.submittedAt?.toDate?.()?.toLocaleString() || "N/A";
              const isLatest = index === 0;
              
              timelineHTML += `
                <div class="timeline-item">
                  <div class="card ${isLatest ? 'border-success' : ''}">
                    <div class="card-body">
                      <div class="d-flex justify-content-between">
                        <h6 class="card-title">Submission ${submissions.length - index}</h6>
                        ${isLatest ? '<span class="badge bg-success">Latest</span>' : ''}
                      </div>
                      <p class="card-text small text-muted">Submitted: ${submittedAt}</p>
                      <a href="${sub.fileURL}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> Download
                      </a>
                    </div>
                  </div>
                </div>
              `;
            });
            
            timelineContainer.innerHTML = timelineHTML;
          }
        } else if (deadline && deadline < now) {
          status = "Expired (Not Submitted)";
          badgeClass = "bg-danger";
          statusBadgeEl.innerHTML = `<span class="status-badge ${badgeClass} text-white">${status}</span>`;
          submissionSection.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle"></i> The deadline for this assignment has passed.
            </div>
          `;
        } else {
          // Show submission upload form
          statusBadgeEl.innerHTML = `<span class="status-badge bg-warning text-dark">Pending Submission</span>`;
          
          submissionSection.innerHTML = `
            <div class="file-upload-area" id="uploadArea">
              <i class="bi bi-cloud-upload fs-1 text-muted mb-3"></i>
              <h5>Drag & Drop your file here</h5>
              <p class="text-muted">or click to browse</p>
              <input type="file" id="fileInput" class="d-none" />
              <button type="button" class="btn btn-success mt-2" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-folder2-open"></i> Select File
              </button>
              <div class="mt-3">
                <small class="text-muted">Supported formats: PDF, DOC, DOCX, ZIP, etc. (Max 50MB)</small>
              </div>
            </div>
            <div id="fileInfo" class="mt-3" style="display: none;"></div>
            <button id="submitBtn" class="btn btn-success w-100 mt-3" style="display: none;">
              <i class="bi bi-send"></i> Submit Assignment
            </button>
            <div id="uploadStatus" class="mt-2"></div>
          `;

          // File upload handling
          const uploadArea = document.getElementById('uploadArea');
          const fileInput = document.getElementById('fileInput');
          const fileInfo = document.getElementById('fileInfo');
          const submitBtn = document.getElementById('submitBtn');
          const uploadStatus = document.getElementById('uploadStatus');
          
          let selectedFile = null;

          // Drag and drop functionality
          uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
          });

          uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
          });

          uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
              fileInput.files = e.dataTransfer.files;
              handleFileSelection(e.dataTransfer.files[0]);
            }
          });

          uploadArea.addEventListener('click', () => {
            fileInput.click();
          });

          fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
              handleFileSelection(e.target.files[0]);
            }
          });

          function handleFileSelection(file) {
            if (file.size > 50 * 1024 * 1024) { // 50MB limit
              showNotification("File size exceeds 50MB limit", true);
              return;
            }

            selectedFile = file;
            fileInfo.innerHTML = `
              <div class="alert alert-info d-flex align-items-center">
                <i class="${getFileIcon(file.name)} me-2 fs-5"></i>
                <div class="flex-grow-1">
                  <strong>${file.name}</strong>
                  <div class="small">${formatFileSize(file.size)}</div>
                </div>
                <button type="button" class="btn-close" onclick="clearFileSelection()"></button>
              </div>
            `;
            fileInfo.style.display = 'block';
            submitBtn.style.display = 'block';
          }

          window.clearFileSelection = function() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            submitBtn.style.display = 'none';
          };

          submitBtn.addEventListener('click', async () => {
            if (!selectedFile) {
              showNotification("Please select a file first", true);
              return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Uploading...';
            uploadStatus.innerHTML = '<div class="alert alert-info">Uploading your submission...</div>';

            try {
              const filePath = `submissions/${assignmentId}/${user.uid}/${Date.now()}_${selectedFile.name}`;
              const { error: uploadError } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(filePath, selectedFile);
              
              if (uploadError) throw uploadError;

              const { data: publicUrlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(filePath);
              
              const fileURL = publicUrlData.publicUrl;

              // Save submission to Firestore
              await db.collection("submissions").add({
                assignmentId,
                studentId: user.uid,
                studentEmail: user.email,
                studentName: userData.name || user.email.split('@')[0],
                fileURL,
                fileName: selectedFile.name,
                fileSize: selectedFile.size,
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                grade: null,
                feedback: ""
              });

              showNotification("Assignment submitted successfully!");
              
              // Update UI
              statusBadgeEl.innerHTML = `<span class="status-badge bg-primary text-white">Submitted (Awaiting Grade)</span>`;
              submissionSection.innerHTML = `
                <div class="alert alert-success">
                  <i class="bi bi-check-circle"></i> Your assignment has been submitted successfully!
                </div>
                <div class="file-preview">
                  <div class="d-flex align-items-center">
                    <i class="${getFileIcon(selectedFile.name)} me-2 fs-4 text-primary"></i>
                    <div class="flex-grow-1">
                      <div class="fw-bold">${selectedFile.name}</div>
                      <div class="small text-muted">${formatFileSize(selectedFile.size)} • Submitted: Just now</div>
                    </div>
                    <a href="${fileURL}" target="_blank" class="btn btn-sm btn-outline-success ms-2">
                      <i class="bi bi-download"></i> Download
                    </a>
                  </div>
                </div>
                <div class="alert alert-info mt-3">
                  <i class="bi bi-info-circle"></i> Your submission is now awaiting grading by your lecturer.
                </div>
              `;
            } catch (err) {
              console.error(err);
              showNotification(`Upload failed: ${err.message}`, true);
              uploadStatus.innerHTML = `<div class="alert alert-danger">Upload failed. Please try again.</div>`;
            } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="bi bi-send"></i> Submit Assignment';
            }
          });
        }

      } catch (err) {
        console.error(err);
        showNotification("Error loading assignment details", true);
      }
    });
  </script>
</body>
</html>