<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Materials - Lecturer Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<style>
  body { 
    background: linear-gradient(135deg, #e3f2fd, #f8f9fa); 
    min-height: 100vh; 
    display: flex; 
    flex-direction: column; 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  /* Navigation Bar */
  .navbar {
    background: linear-gradient(135deg, #1565c0, #0d47a1);
    padding: 1rem 0;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
  }
  .navbar-brand {
    color: white !important;
    font-weight: 700;
    font-size: 1.25rem;
  }
  .navbar-nav .nav-link {
    color: rgba(255,255,255,0.9) !important;
    margin: 0 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
  }
  .navbar-nav .nav-link:hover {
    background: rgba(255,255,255,0.15);
    color: white !important;
  }
  .navbar-nav .nav-link.active {
    background: rgba(255,255,255,0.2);
    color: white !important;
  }
  
  .header { 
    text-align: center; 
    padding: 1.5rem 1rem; 
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
  }
  .header img { 
    width: 80px; 
    height: 80px;
    border-radius: 50%; 
    margin-bottom: 0.5rem; 
    border: 3px solid #1565c0;
    object-fit: cover;
  }
  .header h4 { 
    font-weight: bold; 
    color: #1565c0; 
    margin: 0; 
  }
  .container { 
    max-width: 700px; 
    margin: 2rem auto; 
    background: rgba(255,255,255,0.98); 
    padding: 2.5rem; 
    border-radius: 1.5rem; 
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    border: 1px solid rgba(255,255,255,0.2);
  }
  h2 { 
    color: #1565c0; 
    font-weight: bold; 
    margin-bottom: 1rem;
    text-align: center;
  }
  .btn-primary { 
    background: linear-gradient(135deg, #1565c0, #0d47a1);
    border: none;
    padding: 0.75rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .btn-primary:hover { 
    background: linear-gradient(135deg, #0d47a1, #1565c0);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(13, 71, 161, 0.3);
  }
  .progress { 
    height: 20px; 
    display: none;
    border-radius: 10px;
    overflow: hidden;
  }
  .progress-bar {
    transition: width 0.3s ease;
  }
  footer { 
    margin-top: auto; 
    background: #1565c0; 
    color: white; 
    text-align: center; 
    padding: 1rem; 
    font-size: 0.9rem;
  }
  .form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
  }
  .form-control {
    border-radius: 10px;
    padding: 0.75rem;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
  }
  .form-control:focus {
    border-color: #1565c0;
    box-shadow: 0 0 0 0.2rem rgba(21, 101, 192, 0.25);
  }
  .file-input-wrapper {
    position: relative;
    overflow: hidden;
  }
  .file-input-wrapper input[type=file] {
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    cursor: pointer;
  }
  .file-input-label {
    display: block;
    padding: 1rem;
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .file-input-label:hover {
    border-color: #1565c0;
    background: #e3f2fd;
  }
  .file-name {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #6c757d;
  }
  .loading-spinner {
    display: none;
    width: 1.5rem;
    height: 1.5rem;
  }
</style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="lecturer-dashboard.html">
      <i class="bi bi-mortarboard-fill"></i> Lecturer Portal
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style="background: white;">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="lecturer-dashboard.html">
            <i class="bi bi-house-door"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="upload-materials.html">
            <i class="bi bi-upload"></i> Upload Materials
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="view-materials.html">
            <i class="bi bi-folder2-open"></i> View Materials
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="assignment_page.html">
            <i class="bi bi-pencil-square"></i> Assignments
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="announcements.html">
            <i class="bi bi-megaphone"></i> Announcements
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="forum.html">
            <i class="bi bi-chat-dots"></i> Forum
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Header -->
<div class="header">
  <img src="school.jpg" alt="School Logo">
  <h4>Federal College of Fisheries & Marine Technology</h4>
</div>

<!-- Upload Form -->
<div class="container">
  <h2><i class="bi bi-cloud-upload"></i> Upload Lecture Materials</h2>
  <p class="text-muted text-center mb-4">Share PDFs, PowerPoint presentations, or Word documents with your students.</p>

  <div id="alertBox"></div>

  <form id="uploadForm">
    <div class="mb-4">
      <label class="form-label">Course Code</label>
      <input type="text" id="courseCode" class="form-control" placeholder="e.g. CSC201" required>
    </div>
    <div class="mb-4">
      <label class="form-label">Course Title</label>
      <input type="text" id="courseTitle" class="form-control" placeholder="e.g. Introduction to Programming" required>
    </div>
    <div class="mb-4">
      <label class="form-label">Material Title</label>
      <input type="text" id="materialTitle" class="form-control" placeholder="e.g. Week 1 Lecture Notes" required>
    </div>
    <div class="mb-4">
      <label class="form-label">Upload File</label>
      <div class="file-input-wrapper">
        <input type="file" id="materialFile" class="form-control" accept=".pdf,.ppt,.pptx,.doc,.docx" required>
        <div class="file-input-label" id="fileInputLabel">
          <i class="bi bi-cloud-arrow-up fs-1 text-primary"></i>
          <div class="mt-2">Click to browse or drag and drop</div>
          <small class="text-muted">PDF, PPT, DOC files (Max 25MB)</small>
        </div>
      </div>
      <div class="file-name" id="fileName"></div>
    </div>
    
    <div class="progress mb-4">
      <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
    </div>
    
    <button type="submit" class="btn btn-primary w-100 py-3" id="submitBtn">
      <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
      Upload Material
    </button>
    <a href="view-materials.html" class="btn btn-outline-secondary mt-3 w-100 py-2">
      <i class="bi bi-archive"></i> View My Materials
    </a>
  </form>
</div>

<footer>
  © 2025 Federal College of Fisheries & Marine Technology | Lecturer–Student Interaction System
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
  // Supabase Configuration
  const SUPABASE_URL = "https://jkbbxyxpvwyrwuscujwj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprYmJ4eXhwdnd5cnd1c2N1andqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzg5MjUsImV4cCI6MjA3MzgxNDkyNX0.aTcdR870dKn5bXMDm06wrCDnp7usG8qcU-BaS81ubP4"; 
  const BUCKET_NAME = "Lecturer-Student Storage";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
    authDomain: "lecturer-student-project.firebaseapp.com",
    projectId: "lecturer-student-project",
    storageBucket: "lecturer-student-project.appspot.com",
    messagingSenderId: "266517931898",
    appId: "1:266517931898:web:f48b4af12fdc81001058c3"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // DOM Elements
  const uploadForm = document.getElementById("uploadForm");
  const alertBox = document.getElementById("alertBox");
  const progress = document.querySelector(".progress");
  const progressBar = document.querySelector(".progress-bar");
  const submitBtn = document.getElementById("submitBtn");
  const loadingSpinner = document.querySelector(".loading-spinner");
  const fileInputLabel = document.getElementById("fileInputLabel");
  const fileName = document.getElementById("fileName");
  const materialFile = document.getElementById("materialFile");

  const urlParams = new URLSearchParams(window.location.search);
  const passedCourseCode = urlParams.get("courseCode");
  const passedCourseTitle = urlParams.get("courseTitle");

  const courseCodeInput = document.getElementById("courseCode");
  const courseTitleInput = document.getElementById("courseTitle");

  let selectedCourseId = null;

  // Utility Functions
  function showAlert(message, type = 'info') {
    alertBox.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    
    // Auto-dismiss success messages after 5 seconds
    if (type === 'success') {
      setTimeout(() => {
        const alert = alertBox.querySelector('.alert');
        if (alert) alert.remove();
      }, 10000);
    }
  }

  function setLoadingState(loading) {
    submitBtn.disabled = loading;
    loadingSpinner.style.display = loading ? 'inline-block' : 'none';
    submitBtn.innerHTML = loading ? 
      '<span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span> Uploading...' :
      'Upload Material';
  }

  function validateFile(file) {
    const allowedTypes = [
      'application/pdf',
      'application/vnd.ms-powerpoint',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation',
      'application/msword',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    ];
    
    const maxSize = 25 * 1024 * 1024; // 25MB

    if (!allowedTypes.includes(file.type)) {
      return { valid: false, error: 'Please upload only PDF, PPT, or DOC files.' };
    }

    if (file.size > maxSize) {
      return { valid: false, error: 'File size must be less than 25MB.' };
    }

    return { valid: true };
  }

  function sanitizeInput(text) {
    return text.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // Event Listeners
  materialFile.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      fileName.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
      fileInputLabel.innerHTML = `
        <i class="bi bi-file-earmark-check fs-1 text-success"></i>
        <div class="mt-2">File selected</div>
        <small class="text-muted">${file.name}</small>
      `;
    }
  });

  // Drag and drop functionality
  fileInputLabel.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileInputLabel.style.borderColor = '#1565c0';
    fileInputLabel.style.background = '#e3f2fd';
  });

  fileInputLabel.addEventListener('dragleave', (e) => {
    e.preventDefault();
    fileInputLabel.style.borderColor = '#dee2e6';
    fileInputLabel.style.background = '#f8f9fa';
  });

  fileInputLabel.addEventListener('drop', (e) => {
    e.preventDefault();
    fileInputLabel.style.borderColor = '#dee2e6';
    fileInputLabel.style.background = '#f8f9fa';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      materialFile.files = files;
      materialFile.dispatchEvent(new Event('change'));
    }
  });

  // Authentication and Course Verification
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    // Verify user is a lecturer
    try {
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (!userDoc.exists || userDoc.data().role !== 'lecturer') {
        alert("Access denied. Only lecturers can upload materials.");
        window.location.href = "login.html";
        return;
      }
    } catch (error) {
      console.error("Role verification error:", error);
      window.location.href = "login.html";
      return;
    }

    if (passedCourseCode && passedCourseTitle) {
      // Verify course ownership
      try {
        const coursesRef = db.collection("courses");
        const snapshot = await coursesRef
          .where("courseCode", "==", passedCourseCode)
          .where("lecturerId", "==", user.uid)
          .get();

        if (snapshot.empty) {
          showAlert("You are not authorized to access this course.", "danger");
          setTimeout(() => window.location.href = "lecturer-dashboard.html", 3000);
        } else {
          const courseDoc = snapshot.docs[0];
          selectedCourseId = courseDoc.id;

          courseCodeInput.value = passedCourseCode;
          courseTitleInput.value = passedCourseTitle;
          courseCodeInput.readOnly = true;
          courseTitleInput.readOnly = true;
        }
      } catch (error) {
        console.error("Course verification error:", error);
        showAlert("Error verifying course access.", "danger");
      }
    }
  });

  // Form Submission
  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) {
      showAlert("Please log in to upload materials.", "danger");
      return;
    }

    const courseCode = sanitizeInput(courseCodeInput.value.trim());
    const courseTitle = sanitizeInput(courseTitleInput.value.trim());
    const materialTitle = sanitizeInput(document.getElementById("materialTitle").value.trim());
    const file = document.getElementById("materialFile").files[0];

    // Validation
    if (!courseCode || !courseTitle || !materialTitle) {
      showAlert("Please fill in all required fields.", "danger");
      return;
    }

    if (!file) {
      showAlert("Please select a file to upload.", "danger");
      return;
    }

    const fileValidation = validateFile(file);
    if (!fileValidation.valid) {
      showAlert(fileValidation.error, "danger");
      return;
    }

    setLoadingState(true);
    progress.style.display = "block";
    progressBar.style.width = "0%";
    progressBar.textContent = "0%";

    try {
      // Upload to Supabase
      const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
      const filePath = `materials/${user.uid}/${Date.now()}_${sanitizedFileName}`;

      // Simulate progress
      let fakeProgress = 0;
      const fakeTimer = setInterval(() => {
        fakeProgress = Math.min(80, fakeProgress + Math.random() * 15);
        progressBar.style.width = `${fakeProgress}%`;
        progressBar.textContent = `${Math.round(fakeProgress)}%`;
      }, 200);

      const { error: uploadError } = await supabase.storage
        .from(BUCKET_NAME)
        .upload(filePath, file, { 
          upsert: false,
          cacheControl: '3600'
        });

      clearInterval(fakeTimer);

      if (uploadError) {
        throw new Error(`Upload failed: ${uploadError.message}`);
      }

      // Get public URL
      const { data: publicURLData } = supabase.storage
        .from(BUCKET_NAME)
        .getPublicUrl(filePath);
      
      const fileURL = publicURLData.publicUrl;

      // Complete progress bar
      progressBar.style.width = "100%";
      progressBar.textContent = "100%";

      // Save to Firestore
      await db.collection("materials").add({
        courseCode: courseCode.toUpperCase(),
        courseTitle,
        materialTitle,
        fileURL,
        fileName: file.name,
        fileSize: file.size,
        lecturerId: user.uid,
        courseId: selectedCourseId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Success
      showAlert(`
        ✅ Material uploaded successfully!<br>
        <strong>${materialTitle}</strong> has been uploaded for ${courseCode}.<br>
        <a href="${fileURL}" target="_blank" class="alert-link">View File</a> | 
        <a href="view-materials.html" class="alert-link">View All Materials</a>
      `, "success");

      uploadForm.reset();
      fileName.textContent = '';
      fileInputLabel.innerHTML = `
        <i class="bi bi-cloud-arrow-up fs-1 text-primary"></i>
        <div class="mt-2">Click to browse or drag and drop</div>
        <small class="text-muted">PDF, PPT, DOC files (Max 25MB)</small>
      `;

    } catch (error) {
      console.error("Upload error:", error);
      showAlert(error.message, "danger");
    } finally {
      setLoadingState(false);
      setTimeout(() => {
        progress.style.display = "none";
      }, 1000);
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>