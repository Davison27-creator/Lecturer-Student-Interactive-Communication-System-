<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Uploaded Materials</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #f0f4f8, #ffffff);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      margin-top: 3rem;
      margin-bottom: 3rem;
      flex: 1;
    }
    h2 {
      color: #0d47a1;
      font-weight: 700;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .card {
      border: none;
      border-radius: 15px;
      transition: all 0.3s ease-in-out;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      height: 100%;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .card h5 {
      color: #1565c0;
      font-weight: 600;
    }
    .card p {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 0.5rem;
    }
    .btn-primary {
      background-color: #1565c0;
      border: none;
      border-radius: 8px;
      transition: 0.2s;
    }
    .btn-primary:hover {
      background-color: #0d47a1;
    }
    .btn-danger {
      border-radius: 8px;
    }
    .empty-state {
      text-align: center;
      margin-top: 4rem;
      color: #888;
    }
    .material-meta {
      font-size: 0.85rem;
      color: #6c757d;
    }
    footer {
      background: #1565c0;
      color: white;
      text-align: center;
      padding: 1rem;
      margin-top: auto;
    }
    .file-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #1565c0;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2><i class="bi bi-archive"></i> My Uploaded Materials</h2>
    
    <!-- Statistics -->
    <div class="row mb-4" id="statsContainer">
      <div class="col-md-3">
        <div class="card text-white bg-primary">
          <div class="card-body text-center">
            <h4 id="totalMaterials">0</h4>
            <p>Total Materials</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Materials List -->
    <div id="materialsList" class="row"></div>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-state">
      <i class="bi bi-folder2-open fs-1"></i>
      <p class="mt-3">You haven't uploaded any materials yet.</p>
      <a href="upload-materials.html" class="btn btn-primary mt-2">
        <i class="bi bi-upload"></i> Upload Your First Material
      </a>
    </div>
  </div>

  <footer>
    © 2025 Federal College of Fisheries & Marine Technology | Lecturer–Student Interaction System
  </footer>

  <!-- Firebase + Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    // Supabase Config
    const SUPABASE_URL = "https://jkbbxyxpvwyrwuscujwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprYmJ4eXhwdnd5cnd1c2N1andqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzg5MjUsImV4cCI6MjA3MzgxNDkyNX0.aTcdR870dKn5bXMDm06wrCDnp7usG8qcU-BaS81ubP4";
    const BUCKET_NAME = "Lecturer-Student Storage";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
      authDomain: "lecturer-student-project.firebaseapp.com",
      projectId: "lecturer-student-project",
      storageBucket: "lecturer-student-project.appspot.com",
      messagingSenderId: "266517931898",
      appId: "1:266517931898:web:f48b4af12fdc81001058c3"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const auth = firebase.auth();

    const listDiv = document.getElementById("materialsList");
    const emptyState = document.getElementById("emptyState");
    const totalMaterialsEl = document.getElementById("totalMaterials");

    // Utility function to extract file path from URL
    function getFilePathFromURL(fileURL) {
      try {
        // Extract path from Supabase URL
        const url = new URL(fileURL);
        const pathSegments = url.pathname.split('/');
        // The path is usually after /object/public/
        const publicIndex = pathSegments.indexOf('public');
        if (publicIndex !== -1) {
          return pathSegments.slice(publicIndex + 1).join('/');
        }
        return null;
      } catch (error) {
        console.error('Error parsing file URL:', error);
        return null;
      }
    }

    // Get file icon based on file type
    function getFileIcon(fileName) {
      const ext = fileName.split('.').pop().toLowerCase();
      const iconMap = {
        'pdf': 'bi-file-earmark-pdf',
        'doc': 'bi-file-earmark-word',
        'docx': 'bi-file-earmark-word',
        'ppt': 'bi-file-earmark-ppt',
        'pptx': 'bi-file-earmark-ppt',
        'xls': 'bi-file-earmark-excel',
        'xlsx': 'bi-file-earmark-excel',
        'txt': 'bi-file-earmark-text',
        'zip': 'bi-file-earmark-zip'
      };
      return iconMap[ext] || 'bi-file-earmark';
    }

    // Delete Function (removes from Firestore + Supabase)
    async function deleteMaterial(docId, fileURL, materialTitle) {
      if (!confirm(`Are you sure you want to delete "${materialTitle}"? This action cannot be undone.`)) return;

      try {
        // 1️⃣ Delete from Firestore
        await db.collection("materials").doc(docId).delete();

        // 2️⃣ Delete from Supabase
        const filePath = getFilePathFromURL(fileURL);
        if (filePath) {
          const { error } = await supabase.storage.from(BUCKET_NAME).remove([filePath]);
          if (error) {
            console.warn("Supabase delete error:", error);
            // Continue even if Supabase delete fails
          }
        }

        // Show success message
        const toast = document.createElement('div');
        toast.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
        toast.innerHTML = `
          <strong>Success!</strong> Material deleted successfully.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 3000);

      } catch (err) {
        console.error("Delete error:", err);
        alert("Error deleting material: " + err.message);
      }
    }

    // Authentication and materials loading
    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("Unauthorized access! Redirecting to login...");
        window.location.href = "login.html";
        return;
      }

      // Verify user is a lecturer
      db.collection('users').doc(user.uid).get().then(userDoc => {
        if (!userDoc.exists || userDoc.data().role !== 'lecturer') {
          alert("Access denied. Lecturers only.");
          window.location.href = "login.html";
          return;
        }

        // Load materials
        db.collection("materials")
          .where("lecturerId", "==", user.uid)
          .orderBy("createdAt", "desc")
          .onSnapshot(snapshot => {
            listDiv.innerHTML = "";
            const materials = [];

            if (snapshot.empty) {
              emptyState.classList.remove("d-none");
              totalMaterialsEl.textContent = "0";
              return;
            }

            emptyState.classList.add("d-none");
            totalMaterialsEl.textContent = snapshot.size;

            snapshot.forEach(doc => {
              const mat = doc.data();
              const docId = doc.id;
              materials.push(mat);

              const createdAt = mat.createdAt?.toDate ? mat.createdAt.toDate().toLocaleDateString() : 'Unknown date';
              const fileIcon = getFileIcon(mat.fileName || mat.fileURL);

              listDiv.innerHTML += `
                <div class="col-md-6 col-lg-4 mb-4">
                  <div class="card p-3 shadow-sm">
                    <div class="card-body text-center">
                      <div class="file-icon">
                        <i class="bi ${fileIcon}"></i>
                      </div>
                      <h5 class="card-title">${mat.materialTitle}</h5>
                      <p class="card-text"><strong>Course:</strong> ${mat.courseCode} - ${mat.courseTitle}</p>
                      <p class="material-meta">
                        <i class="bi bi-calendar"></i> Uploaded: ${createdAt}
                      </p>
                      ${mat.fileName ? `<p class="material-meta"><i class="bi bi-file-text"></i> ${mat.fileName}</p>` : ''}
                      <div class="d-flex justify-content-between mt-3">
                        <a href="${mat.fileURL}" target="_blank" class="btn btn-sm btn-primary">
                          <i class="bi bi-download"></i> Download
                        </a>
                        <button class="btn btn-sm btn-danger" onclick="deleteMaterial('${docId}', '${mat.fileURL}', '${mat.materialTitle.replace(/'/g, "\\'")}')">
                          <i class="bi bi-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });
          }, error => {
            console.error("Error loading materials:", error);
            listDiv.innerHTML = `<div class="col-12"><div class="alert alert-danger">Error loading materials. Please refresh the page.</div></div>`;
          });

      }).catch(error => {
        console.error("Role verification error:", error);
        window.location.href = "login.html";
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>