<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lecturer Profile & Settings</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --accent: #1565c0;
      --accent-dark: #0d47a1;
      --accent-light: #e3f2fd;
      --card-bg: rgba(255,255,255,0.95);
      --success-color: #2e7d32;
      --warning-color: #f57c00;
      --danger-color: #c62828;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1a237e;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* Navigation Bar */
    .navbar {
      width: 100%;
      background: linear-gradient(135deg, #1565c0, #0d47a1);
      padding: 1rem 0;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .navbar-brand {
      color: white !important;
      font-weight: 700;
      font-size: 1.25rem;
    }
    .navbar-nav .nav-link {
      color: rgba(255,255,255,0.9) !important;
      margin: 0 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .navbar-nav .nav-link:hover {
      background: rgba(255,255,255,0.15);
      color: white !important;
    }
    .navbar-nav .nav-link.active {
      background: rgba(255,255,255,0.2);
      color: white !important;
    }
    
    .page-wrapper {
      width: 100%;
      padding: 0 1rem 2rem;
      display: flex;
      align-items: start;
      justify-content: center;
    }

    .profile-card { 
      width: 100%; 
      max-width: 1000px; 
      background: var(--card-bg); 
      border-radius: 20px; 
      box-shadow: 0 20px 60px rgba(13,47,81,0.15); 
      padding: 2rem; 
      backdrop-filter: blur(10px); 
      border: 1px solid rgba(255,255,255,0.3);
      position: relative;
      overflow: hidden;
    }

    .profile-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    }

    .header { 
      display: flex; 
      gap: 1rem; 
      align-items: center; 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 2px solid rgba(13,47,81,0.08);
    }

    .brand-title { 
      font-weight: 800; 
      color: var(--accent-dark); 
      margin: 0; 
      font-size: 1.5rem;
      background: linear-gradient(135deg, var(--accent-dark), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .brand-sub { 
      margin: 0.5rem 0 0 0; 
      color: #5c6bc0; 
      font-size: 1rem;
      font-weight: 400;
    }

    .main-content {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
    }

    .sidebar { 
      width: 280px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 1rem; 
      padding: 1.5rem; 
      background: var(--accent-light);
      border-radius: 16px;
      border: 1px solid rgba(21, 101, 192, 0.1);
    }

    .avatar { 
      width: 140px; 
      height: 140px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 6px solid #fff; 
      box-shadow: 0 12px 30px rgba(13,47,81,0.15); 
      background: linear-gradient(135deg,#fff,#e3f2fd);
      transition: all 0.3s ease;
    }

    .avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 16px 40px rgba(13,47,81,0.2);
    }

    .change-photo { 
      width: 100%; 
      text-align: center; 
    }

    .btn-upload { 
      border-radius: 12px; 
      padding: 0.5rem 1.25rem; 
      font-size: 0.9rem;
      font-weight: 600;
      border: 2px dashed var(--accent);
      background: rgba(255,255,255,0.8);
      color: var(--accent);
      transition: all 0.3s ease;
    }

    .btn-upload:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
    }

    .content-area { 
      flex: 1; 
      padding: 0.5rem 0.5rem 0.5rem 1rem; 
    }

    label { 
      font-weight: 600; 
      color: #283593; 
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .form-control, .form-select { 
      border-radius: 12px;
      border: 2px solid #e8eaf6;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
      transform: translateY(-1px);
    }

    .muted { 
      color: #7986cb; 
      font-size: 0.9rem; 
    }

    .section { 
      margin-bottom: 1.5rem; 
      padding: 1.5rem;
      background: rgba(255,255,255,0.7);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.5);
    }

    .section-title {
      font-weight: 700;
      color: var(--accent-dark);
      margin-bottom: 1rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title i {
      color: var(--accent);
    }

    .save-btn { 
      background: linear-gradient(135deg, var(--accent), var(--accent-dark)); 
      border: none; 
      color: white; 
      border-radius: 12px; 
      padding: 0.75rem 1.5rem; 
      font-weight: 600; 
      box-shadow: 0 8px 25px rgba(21,101,192,0.2);
      transition: all 0.3s ease;
    }

    .save-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(21,101,192,0.3);
    }

    .save-btn:disabled {
      opacity: 0.7;
      transform: none;
      box-shadow: none;
    }

    .danger-btn { 
      background: #fff; 
      color: var(--danger-color); 
      border: 2px solid rgba(198,40,40,0.2);
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .danger-btn:hover {
      background: var(--danger-color);
      color: white;
      transform: translateY(-2px);
    }

    .hr { 
      height: 2px; 
      background: linear-gradient(90deg, transparent, rgba(13,47,81,0.1), transparent); 
      margin: 1.5rem 0; 
      border-radius: 2px; 
    }

    .small-note { 
      font-size: 0.85rem; 
      color: #7986cb; 
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      border: 1px solid rgba(21, 101, 192, 0.1);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #5c6bc0;
      font-weight: 500;
    }

    .alert-custom {
      border-radius: 12px;
      border: none;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
    }

    .badge-custom {
      border-radius: 20px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .last-updated {
      background: rgba(21, 101, 192, 0.1);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      border-left: 4px solid var(--accent);
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
      }
      
      .content-area {
        padding: 0;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }

    .password-strength {
      height: 4px;
      border-radius: 2px;
      margin-top: 0.5rem;
      background: #e0e0e0;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      border-radius: 2px;
      transition: all 0.3s ease;
    }
  </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="lecturer-dashboard.html">
      <i class="bi bi-mortarboard-fill"></i> Lecturer Portal
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style="background: white;">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="lecturer-dashboard.html">
            <i class="bi bi-house-door"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="upload-materials.html">
            <i class="bi bi-upload"></i> Upload Materials
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="view-materials.html">
            <i class="bi bi-folder2-open"></i> View Materials
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="assignment_page.html">
            <i class="bi bi-pencil-square"></i> Assignments
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="announcements.html">
            <i class="bi bi-megaphone"></i> Announcements
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="forum.html">
            <i class="bi bi-chat-dots"></i> Forum
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="lecturer-profile.html">
            <i class="bi bi-person-circle"></i> Profile
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="page-wrapper">
  <div class="profile-card">
    <div class="header">
      <div>
        <p class="brand-title"><i class="bi bi-person-gear"></i> Lecturer Profile & Settings</p>
        <p class="brand-sub">Manage your profile information, security settings, and account preferences</p>
      </div>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <img id="avatarPreview" src="school.jpg" alt="avatar" class="avatar" />
        <div class="change-photo w-100">
          <label class="btn btn-upload mb-2 w-100" for="photoInput">
            <i class="bi bi-cloud-upload"></i> Change Photo
          </label>
          <input id="photoInput" type="file" accept="image/*" style="display:none" />
          <div class="muted small-note mt-1">JPG, PNG, WebP • Max 5MB</div>
        </div>
        
        <div style="width:100%; margin-top:1rem;">
          <div class="small-note mb-2">Account Status</div>
          <div id="roleBadge" class="badge bg-primary badge-custom w-100">
            <i class="bi bi-person-check"></i> Verified Lecturer
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="coursesCount">0</div>
            <div class="stat-label">Courses</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="studentsCount">0</div>
            <div class="stat-label">Students</div>
          </div>
        </div>

        <div class="last-updated w-100 mt-2">
          <div class="small-note">Last Updated</div>
          <div class="fw-semibold" id="lastUpdated">—</div>
        </div>
      </div>

      <div class="content-area">
        <div id="alerts"></div>

        <!-- Personal Information Section -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-person-vcard"></i> Personal Information
          </div>
          <label for="fullName">Full Name</label>
          <input id="fullName" class="form-control mb-3" placeholder="Enter your full name" />
          <div class="row g-3">
            <div class="col-md-6">
              <label for="department">Department</label>
              <input id="department" class="form-control" placeholder="e.g. Computer Science" />
            </div>
            <div class="col-md-6">
              <label for="phone">Phone Number</label>
              <input id="phone" class="form-control" placeholder="+234 800 000 0000" />
            </div>
          </div>
          <div class="muted mt-2">This information is visible to students in your courses.</div>
        </div>

        <!-- Account Security Section -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-shield-lock"></i> Account Security
          </div>
          <label for="email">Email Address</label>
          <input id="email" type="email" class="form-control mb-3" placeholder="your.email@university.edu" />
          <div class="small-note mb-3">To change your email or password, you must verify your current password.</div>
          
          <div class="row g-3">
            <div class="col-md-6">
              <label for="currentPassword">Current Password</label>
              <input id="currentPassword" type="password" class="form-control" placeholder="Enter current password" />
            </div>
            <div class="col-md-6">
              <label for="newPassword">New Password</label>
              <input id="newPassword" type="password" class="form-control" placeholder="Minimum 6 characters" />
              <div class="password-strength mt-2">
                <div class="password-strength-bar" id="passwordStrengthBar"></div>
              </div>
            </div>
          </div>
          
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label for="confirmPassword">Confirm New Password</label>
              <input id="confirmPassword" type="password" class="form-control" placeholder="Re-enter new password" />
            </div>
            <div class="col-md-6">
              <div class="muted small-note">
                <i class="bi bi-info-circle"></i> Leave password fields empty if you don't want to change your password.
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="section">
          <div class="d-flex flex-column flex-md-row gap-3 align-items-stretch align-items-md-center">
            <button id="saveBtn" class="save-btn">
              <i class="bi bi-check-circle"></i> Save Changes
            </button>
            <button id="signOutBtn" class="btn btn-outline-secondary">
              <i class="bi bi-box-arrow-right"></i> Sign Out
            </button>
            <button id="deleteAccountBtn" class="btn danger-btn ms-md-auto">
              <i class="bi bi-trash"></i> Delete Account
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const SUPABASE_URL = "https://jkbbxyxpvwyrwuscujwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprYmJ4eXhwdnd5cnd1c2N1andqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzg5MjUsImV4cCI6MjA3MzgxNDkyNX0.aTcdR870dKn5bXMDm06wrCDnp7usG8qcU-BaS81ubP4"; 
    const BUCKET_NAME = "Lecturer-Student Storage"; 

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const firebaseConfig = {
      apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
      authDomain: "lecturer-student-project.firebaseapp.com",
      projectId: "lecturer-student-project",
      storageBucket: "lecturer-student-project.appspot.com",
      messagingSenderId: "266517931898",
      appId: "1:266517931898:web:f48b4af12fdc81001058c3"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Elements
    const avatarPreview = document.getElementById('avatarPreview');
    const photoInput = document.getElementById('photoInput');
    const fullNameEl = document.getElementById('fullName');
    const departmentEl = document.getElementById('department');
    const phoneEl = document.getElementById('phone');
    const emailEl = document.getElementById('email');
    const currentPasswordEl = document.getElementById('currentPassword');
    const newPasswordEl = document.getElementById('newPassword');
    const confirmPasswordEl = document.getElementById('confirmPassword');
    const saveBtn = document.getElementById('saveBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const alerts = document.getElementById('alerts');
    const lastUpdated = document.getElementById('lastUpdated');
    const roleBadge = document.getElementById('roleBadge');
    const coursesCountEl = document.getElementById('coursesCount');
    const studentsCountEl = document.getElementById('studentsCount');
    const passwordStrengthBar = document.getElementById('passwordStrengthBar');

    let currentUser = null, userDocRef = null, userData = null, localPhotoFile = null;
    let hasUnsavedChanges = false;

    // Utility Functions
    function showAlert(msg, type = 'success', timeout = 5000) {
      const id = 'alert-' + Date.now();
      const icon = type === 'success' ? 'bi-check-circle' : 
                   type === 'warning' ? 'bi-exclamation-triangle' : 
                   'bi-exclamation-circle';
      
      alerts.innerHTML = `
        <div id="${id}" class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
          <i class="bi ${icon} me-2"></i>${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      if (timeout) {
        setTimeout(() => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('show');
        }, timeout);
      }
    }

    function formatTimestamp(ts) {
      try {
        if (!ts) return '—';
        return ts.toDate().toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return '—';
      }
    }

    function setLoadingState(loading) {
      saveBtn.disabled = loading;
      saveBtn.innerHTML = loading 
        ? '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...' 
        : '<i class="bi bi-check-circle"></i> Save Changes';
    }

    function validateInputs() {
      const newName = fullNameEl.value.trim();
      const newPhone = phoneEl.value.trim();
      const newPassword = newPasswordEl.value;
      const confirmPassword = confirmPasswordEl.value;
      
      // Name validation
      if (!newName) {
        showAlert('Full name is required', 'danger');
        return false;
      }
      
      if (newName.length < 2) {
        showAlert('Name must be at least 2 characters long', 'danger');
        return false;
      }
      
      // Phone validation (if provided)
      if (newPhone && !/^[\d\s\-\+\(\)]{10,20}$/.test(newPhone.replace(/\s/g, ''))) {
        showAlert('Please enter a valid phone number', 'danger');
        return false;
      }
      
      // Password validation
      if (newPassword) {
        if (newPassword.length < 6) {
          showAlert('Password must be at least 6 characters long', 'danger');
          return false;
        }
        
        if (newPassword !== confirmPassword) {
          showAlert('New password and confirmation do not match', 'danger');
          return false;
        }
        
        if (!currentPasswordEl.value) {
          showAlert('Current password is required to change password', 'danger');
          return false;
        }
      }
      
      // Email change requires current password
      if (emailEl.value.trim() !== currentUser.email && !currentPasswordEl.value) {
        showAlert('Current password is required to change email', 'danger');
        return false;
      }
      
      return true;
    }

    function updatePasswordStrength(password) {
      let strength = 0;
      if (password.length >= 6) strength += 25;
      if (password.length >= 8) strength += 25;
      if (/[A-Z]/.test(password)) strength += 25;
      if (/[0-9]/.test(password)) strength += 25;
      
      let color = '#f44336'; // red
      if (strength >= 50) color = '#ff9800'; // orange
      if (strength >= 75) color = '#4caf50'; // green
      
      passwordStrengthBar.style.width = strength + '%';
      passwordStrengthBar.style.background = color;
    }

    function compressImage(file, maxWidth = 400, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          
          canvas.width = width;
          canvas.height = height;
          
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob(resolve, 'image/jpeg', quality);
        };
        
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    // FIXED: Safe file name generation
    function getSafeFileName(file) {
      if (!file) return 'profile.jpg';
      
      // Handle cases where file.name might be undefined
      const originalName = file.name || 'profile';
      const timestamp = Date.now();
      
      // Remove special characters and replace spaces with underscores
      const safeName = originalName
        .replace(/[^a-zA-Z0-9.\-_]/g, '_')
        .replace(/\s+/g, '_')
        .substring(0, 100); // Limit length
      
      return `${timestamp}_${safeName}`;
    }

    async function loadLecturerStats(userId) {
      try {
        // Count courses created by this lecturer
        const coursesSnap = await db.collection('courses')
          .where('lecturerId', '==', userId)
          .get();
        
        coursesCountEl.textContent = coursesSnap.size;
        
        // Count total students across all courses
        let totalStudents = 0;
        for (const courseDoc of coursesSnap.docs) {
          const studentsSnap = await db.collection('studentCourses')
            .where('courseId', '==', courseDoc.id)
            .get();
          totalStudents += studentsSnap.size;
        }
        
        studentsCountEl.textContent = totalStudents;
      } catch (error) {
        console.error('Error loading stats:', error);
        coursesCountEl.textContent = '0';
        studentsCountEl.textContent = '0';
      }
    }

    // Event Listeners
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      
      currentUser = user;
      userDocRef = db.collection('users').doc(user.uid);

      try {
        const doc = await userDocRef.get();
        if (!doc.exists) {
          await auth.signOut();
          window.location.href = 'login.html';
          return;
        }
        
        userData = doc.data();
        
        if (userData.role !== 'lecturer') {
          showAlert('Access denied — lecturer account required', 'danger', 2500);
          setTimeout(async () => {
            await auth.signOut();
            window.location.href = 'login.html';
          }, 1200);
          return;
        }

        // Populate form fields
        roleBadge.textContent = `Role: ${userData.role || 'Lecturer'}`;
        fullNameEl.value = userData.name || '';
        departmentEl.value = userData.department || '';
        phoneEl.value = userData.phone || '';
        emailEl.value = userData.email || currentUser.email || '';
        lastUpdated.textContent = formatTimestamp(userData.updatedAt || userData.createdAt || null);
        avatarPreview.src = userData.photoURL || currentUser.photoURL || 'school.jpg';
        
        // Load statistics
        await loadLecturerStats(user.uid);
        
        showAlert('Welcome back! Your profile has been loaded successfully.', 'success', 3000);
        
      } catch (err) {
        console.error('Error loading profile:', err);
        showAlert('Failed to load profile data. Please refresh the page.', 'danger', 5000);
      }
    });

    photoInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Validate file type and size
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        showAlert('Please select a valid image file (JPG, PNG, WebP)', 'danger');
        photoInput.value = '';
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        showAlert('File size must be less than 5MB', 'danger');
        photoInput.value = '';
        return;
      }
      
      try {
        // Compress image before upload
        const compressedFile = await compressImage(file);
        localPhotoFile = compressedFile;
        
        // Preview the image
        const reader = new FileReader();
        reader.onload = (e) => {
          avatarPreview.src = e.target.result;
          hasUnsavedChanges = true;
        };
        reader.readAsDataURL(compressedFile);
        
        showAlert('Photo ready to upload. Click Save Changes to update your profile.', 'info');
      } catch (err) {
        console.error('Image processing failed:', err);
        // Fallback to original file
        localPhotoFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          avatarPreview.src = e.target.result;
          hasUnsavedChanges = true;
        };
        reader.readAsDataURL(file);
      }
    });

    // Track form changes
    [fullNameEl, departmentEl, phoneEl, emailEl].forEach(input => {
      input.addEventListener('input', () => {
        hasUnsavedChanges = true;
      });
    });

    newPasswordEl.addEventListener('input', (e) => {
      updatePasswordStrength(e.target.value);
      hasUnsavedChanges = true;
    });

    confirmPasswordEl.addEventListener('input', () => {
      hasUnsavedChanges = true;
    });

    saveBtn.addEventListener('click', async () => {
      if (!validateInputs()) {
        return;
      }
      
      setLoadingState(true);
      
      try {
        const newName = fullNameEl.value.trim();
        const newDept = departmentEl.value.trim();
        const newPhone = phoneEl.value.trim();
        const newEmail = emailEl.value.trim();
        const currentPassword = currentPasswordEl.value;
        const newPassword = newPasswordEl.value;
        
        let needReauth = false;
        if ((newEmail && newEmail !== currentUser.email) || (newPassword && newPassword.length > 0)) {
          needReauth = true;
          if (!currentPassword) {
            showAlert('Current password is required for security changes', 'danger');
            throw new Error('reauth-required');
          }
        }
        
        // Reauthenticate if needed
        if (needReauth) {
          const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
          await currentUser.reauthenticateWithCredential(cred);
        }
        
        // Upload new photo if selected
        let photoURL = userData.photoURL || currentUser.photoURL || null;
        if (localPhotoFile) {
          // FIXED: Use safe file name generation
          const fileName = getSafeFileName(localPhotoFile);
          const filePath = `profile_pics/${currentUser.uid}/${fileName}`;
          
          const { error } = await supabase.storage.from(BUCKET_NAME).upload(filePath, localPhotoFile, { 
            upsert: true,
            cacheControl: '3600'
          });
          
          if (error) {
            console.error('Supabase upload error:', error);
            throw new Error('Failed to upload image: ' + error.message);
          }
          
          const { data: urlData, error: urlErr } = supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath);
          if (urlErr) {
            console.error('Supabase URL error:', urlErr);
            throw new Error('Failed to get image URL: ' + urlErr.message);
          }
          
          photoURL = urlData.publicUrl;
          
          // Update Firebase auth profile photo
          try {
            await currentUser.updateProfile({ photoURL });
          } catch (e) {
            console.warn('Failed to update auth profile photo:', e);
          }
        }
        
        // Update email if changed
        if (newEmail && newEmail !== currentUser.email) {
          await currentUser.updateEmail(newEmail);
        }
        
        // Update password if provided
        if (newPassword && newPassword.length > 0) {
          await currentUser.updatePassword(newPassword);
        }
        
        // Update Firestore user document
        const updateData = {
          name: newName,
          department: newDept || '',
          phone: newPhone || '',
          email: newEmail || currentUser.email,
          photoURL: photoURL || '',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await userDocRef.set(updateData, { merge: true });
        
        // Clear sensitive fields
        currentPasswordEl.value = '';
        newPasswordEl.value = '';
        confirmPasswordEl.value = '';
        passwordStrengthBar.style.width = '0%';
        localPhotoFile = null;
        hasUnsavedChanges = false;
        
        // Refresh user data
        const freshDoc = await userDocRef.get();
        userData = freshDoc.data();
        lastUpdated.textContent = formatTimestamp(userData.updatedAt || userData.createdAt || null);
        
        showAlert('Profile updated successfully!', 'success');
        
      } catch (err) {
        console.error('Save error:', err);
        
        if (err.message === 'reauth-required') {
          // Already handled
        } else if (err.code === 'auth/wrong-password') {
          showAlert('Current password is incorrect', 'danger');
        } else if (err.code === 'auth/requires-recent-login') {
          showAlert('Please sign in again to make these changes', 'danger');
        } else {
          showAlert('Failed to save changes: ' + (err.message || 'Unknown error'), 'danger', 6000);
        }
      } finally {
        setLoadingState(false);
      }
    });

    signOutBtn.addEventListener('click', async () => {
      if (hasUnsavedChanges && !confirm('You have unsaved changes. Are you sure you want to sign out?')) {
        return;
      }
      
      showAlert('Signing out...', 'info', 2000);
      setTimeout(async () => {
        await auth.signOut();
        window.location.href = 'login.html';
      }, 1000);
    });

    deleteAccountBtn.addEventListener('click', async () => {
      const password = prompt('Please enter your password to confirm account deletion:');
      if (!password) return;
      
      try {
        const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
        await currentUser.reauthenticateWithCredential(cred);
        
        const confirmation = confirm('⚠️ DANGER: This will permanently delete your account and all associated data including courses, assignments, and student records. This action cannot be undone. Are you absolutely sure?');
        
        if (confirmation) {
          setLoadingState(true);
          await userDocRef.delete();
          await currentUser.delete();
          showAlert('Account deleted successfully. Redirecting...', 'success', 2000);
          setTimeout(() => window.location.href = 'login.html', 1500);
        }
      } catch (err) {
        console.error('Delete error:', err);
        if (err.code === 'auth/wrong-password') {
          showAlert('Incorrect password. Account deletion cancelled.', 'danger');
        } else {
          showAlert('Failed to delete account: ' + (err.message || 'Recent sign-in required'), 'danger', 7000);
        }
      } finally {
        setLoadingState(false);
      }
    });

    // Warn about unsaved changes
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      }
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>