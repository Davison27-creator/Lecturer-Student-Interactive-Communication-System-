<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grade Submission</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      background: #fff;
      margin-top: 4rem;
      border-radius: 18px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.1);
      padding: 2.5rem;
      max-width: 800px;
    }
    h2 {
      color: #0d47a1;
      font-weight: 700;
    }
    .submission-info {
      background: #f1f8ff;
      border-left: 4px solid #1565c0;
      padding: 1rem;
      border-radius: 10px;
    }
    label {
      font-weight: 600;
    }
    .btn-save {
      background: #1565c0;
      border: none;
      transition: 0.3s ease;
    }
    .btn-save:hover {
      background: #0d47a1;
      transform: scale(1.03);
    }
    .footer {
      margin-top: auto;
      background: #0d47a1;
      color: white;
      text-align: center;
      padding: 0.8rem;
      font-size: 0.9rem;
    }
    .back-btn {
      text-decoration: none;
      color: #1565c0;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 1rem;
      transition: 0.2s ease;
    }
    .back-btn:hover {
      color: #0d47a1;
      transform: translateX(-3px);
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="javascript:history.back()" class="back-btn"><i class="bi bi-arrow-left"></i> Back to Submissions</a>

    <h2 class="mb-3"><i class="bi bi-journal-check"></i> Grade Submission</h2>

    <div id="submissionDetails" class="submission-info mb-4">
      <div class="spinner-border text-primary" role="status"></div> Loading submission details...
    </div>

    <form id="gradeForm">
      <div class="mb-3">
        <label for="grade" class="form-label">Grade (Score)</label>
        <input type="number" id="grade" class="form-control" min="0" max="100" placeholder="Enter grade (e.g., 85)" required>
      </div>

      <div class="mb-3">
        <label for="feedback" class="form-label">Feedback (Optional)</label>
        <textarea id="feedback" class="form-control" rows="4" placeholder="Enter your feedback for this submission..."></textarea>
      </div>

      <button type="submit" class="btn btn-save w-100 text-white fw-bold">
        <i class="bi bi-send-check"></i> Save Grade
      </button>
    </form>
  </div>

  <footer class="footer">© 2025 Federal College of Fisheries & Marine Technology</footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  (async function(){
    // ✅ Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
      authDomain: "lecturer-student-project.firebaseapp.com",
      projectId: "lecturer-student-project",
      storageBucket: "lecturer-student-project.appspot.com",
      messagingSenderId: "266517931898",
      appId: "1:266517931898:web:f48b4af12fdc81001058c3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Get query params
    const urlParams = new URLSearchParams(window.location.search);
    const submissionId = urlParams.get("submissionId");
    const assignmentId = urlParams.get("assignmentId");

    const submissionDetails = document.getElementById("submissionDetails");
    const gradeForm = document.getElementById("gradeForm");

    if(!submissionId || !assignmentId){
      submissionDetails.innerHTML = `<div class="text-danger fw-bold">❌ Missing submission or assignment ID in URL.</div>`;
      gradeForm.style.display = "none";
      return;
    }

    try {
      const subDoc = await db.collection("submissions").doc(submissionId).get();

      if(!subDoc.exists){
        submissionDetails.innerHTML = `<div class="text-danger fw-bold">Submission not found.</div>`;
        gradeForm.style.display = "none";
        return;
      }

      const sub = subDoc.data();
      const submittedAt = sub.submittedAt?.toDate ? sub.submittedAt.toDate().toLocaleString() : "N/A";
      const fileURL = sub.fileURL ? `<a href="${sub.fileURL}" target="_blank" class="btn btn-sm btn-outline-primary mt-2"><i class="bi bi-box-arrow-up-right"></i> View File</a>` : "No file uploaded";

      submissionDetails.innerHTML = `
        <p><strong>Student Email:</strong> ${sub.studentEmail || "Unknown"}</p>
        <p><strong>Submitted At:</strong> ${submittedAt}</p>
        <p><strong>File:</strong> ${fileURL}</p>
        <p><strong>Current Grade:</strong> ${sub.grade || "Not graded yet"}</p>
      `;

      if(sub.grade) document.getElementById("grade").value = sub.grade;
      if(sub.feedback) document.getElementById("feedback").value = sub.feedback;

      // ✅ Handle Grade Form Submission
      gradeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const grade = document.getElementById("grade").value.trim();
        const feedback = document.getElementById("feedback").value.trim();

        if(!grade) return alert("Please enter a grade.");

        try {
          // Update in submissions collection
          await db.collection("submissions").doc(submissionId).update({
            grade: parseFloat(grade),
            feedback: feedback || "",
            gradedAt: new Date()
          });

          // Reflect in student_grades collection
          const studentEmail = sub.studentEmail || "unknown_student";
          const gradeDocId = `${studentEmail}_${assignmentId}`;

          await db.collection("student_grades").doc(gradeDocId).set({
            studentEmail,
            assignmentId,
            grade: parseFloat(grade),
            feedback: feedback || "",
            updatedAt: new Date()
          }, { merge: true });

          alert("✅ Grade successfully saved and reflected on student’s grade page!");
          window.location.href = `view-submissions.html?assignmentId=${assignmentId}`;

        } catch (err) {
          console.error("Error saving grade:", err);
          alert("❌ Failed to save grade. Please try again.");
        }
      });

    } catch (error) {
      console.error("Error loading submission:", error);
      submissionDetails.innerHTML = `<div class="text-danger">Error fetching submission details.</div>`;
    }
  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
