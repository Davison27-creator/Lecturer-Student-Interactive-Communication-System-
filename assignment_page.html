<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Assignment - Lecturer Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg,#e3f2fd,#f8f9fa);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      font-family: 'Poppins', sans-serif;
    }
    .header { text-align:center; padding:1rem; }
    .header img { width:80px; border-radius:50%; margin-bottom:.5rem; }
    .header h4 { color:#1565c0; margin:0; font-weight:700; }
    .card-container {
      max-width: 900px;
      margin: 2rem auto;
      background: rgba(255,255,255,0.98);
      padding: 1.6rem;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    }
    .btn-primary { background:#1565c0; border: none; }
    .btn-primary:hover { background:#0d47a1; }
    footer { margin-top:auto; background:#1565c0; color:#fff; text-align:center; padding:.8rem; }
    .small-muted { color:#6c757d; font-size:.92rem; }
    .progress { height:20px; display:none; }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <img src="school.jpg" alt="School Logo" />
    <h4>Federal College of Fisheries & Marine Technology</h4>
  </div>

  <!-- Card -->
  <div class="card-container">
    <h3 class="mb-3"><i class="bi bi-file-earmark-text"></i> Create Assignment / Quiz</h3>
    <p class="small-muted">Fill in the details below. File attachment is optional (PDF/DOC/PPT).</p>

    <div id="alertBox"></div>

    <form id="assignmentForm" novalidate>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Course Code</label>
          <input id="courseCode" class="form-control" type="text" placeholder="e.g. CSC201" required>
        </div>
        <div class="col-md-8">
          <label class="form-label">Course Title</label>
          <input id="courseTitle" class="form-control" type="text" placeholder="e.g. Introduction to Programming" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Department</label>
          <select id="department" class="form-select" required>
            <option value="">Select Department</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Statistics">Statistics</option>
            <option value="Science Laboratory Technology">Science Lab Tech</option>
            <option value="Marine Engineering">Marine Engineering</option>
            <option value="Fisheries">Fisheries</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Level</label>
          <select id="level" class="form-select" required>
            <option value="">Select Level</option>
            <option value="ND1">ND1</option>
            <option value="ND2">ND2</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Assignment / Quiz Title</label>
          <input id="assignmentTitle" class="form-control" type="text" placeholder="e.g. Assignment 1 - Variables" required>
        </div>

        <div class="col-12">
          <label class="form-label">Description / Instructions</label>
          <textarea id="description" class="form-control" rows="5" placeholder="Add instructions, rubric, expectations..." required></textarea>
        </div>

        <div class="col-md-6">
          <label class="form-label">Deadline (date)</label>
          <input id="deadlineDate" class="form-control" type="date" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Deadline (time)</label>
          <input id="deadlineTime" class="form-control" type="time" required>
        </div>

        <div class="col-12">
          <label class="form-label">Attach File (optional)</label>
          <input id="assignmentFile" class="form-control" type="file" accept=".pdf,.doc,.docx,.ppt,.pptx" />
          <div class="form-text">Optional — attach assignment sheet, dataset, etc.</div>
        </div>

        <div class="col-12">
          <div class="progress mb-2">
            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%">0%</div>
          </div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-primary">Create Assignment</button>
          <a href="view-assignments.html" class="btn btn-outline-secondary">View My Assignments</a>
        </div>
      </div>
    </form>
  </div>

  <footer>© 2025 Federal College of Fisheries & Marine Technology</footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
  (async function(){
    // ---------- CONFIG ----------
    const SUPABASE_URL = "https://jkbbxyxpvwyrwuscujwj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprYmJ4eXhwdnd5cnd1andqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzg5MjUsImV4cCI6MjA3MzgxNDkyNX0.aTcdR870dKn5bXMDm06wrCDnp7usG8qcU-BaS81ubP4";
    const BUCKET_ID = "Lecturer-Student Storage";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const firebaseConfig = {
      apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
      authDomain: "lecturer-student-project.firebaseapp.com",
      projectId: "lecturer-student-project",
      storageBucket: "lecturer-student-project.appspot.com",
      messagingSenderId: "266517931898",
      appId: "1:266517931898:web:f48b4af12fdc81001058c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ---------- DOM ----------
    const form = document.getElementById('assignmentForm');
    const alertBox = document.getElementById('alertBox');
    const uploadProgress = document.querySelector('.progress');
    const uploadProgressBar = document.getElementById('uploadProgressBar');

    function showAlert(msg, type='info', timeout=6000){
      alertBox.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
      if(timeout) setTimeout(()=> { const a = alertBox.querySelector('.alert'); if(a) a.classList.remove('show'); }, timeout);
    }

    // ---------- COURSE VERIFICATION ----------
    const urlParams = new URLSearchParams(window.location.search);
    const passedCourseCode = urlParams.get("courseCode");
    const passedCourseTitle = urlParams.get("courseTitle");

    const courseCodeInput = document.getElementById("courseCode");
    const courseTitleInput = document.getElementById("courseTitle");
    let verifiedCourseId = null;

    auth.onAuthStateChanged(async (user) => {
      if(!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        const doc = await db.collection('users').doc(user.uid).get();
        if (!doc.exists || doc.data().role !== 'lecturer') {
          showAlert('Access denied. Only lecturers can create assignments.', 'danger', 0);
          setTimeout(() => auth.signOut().then(() => window.location.href='login.html'), 3000);
          return;
        }

        if(passedCourseCode && passedCourseTitle){
          const coursesRef = db.collection("courses");
          const snapshot = await coursesRef
            .where("courseCode", "==", passedCourseCode)
            .where("lecturerId", "==", user.uid)
            .get();

          if(snapshot.empty){
            alert("You are not authorized to access this course.");
            window.location.href = "lecturer-dashboard.html";
          } else {
            courseCodeInput.value = passedCourseCode;
            courseTitleInput.value = passedCourseTitle;
            courseCodeInput.readOnly = true;
            courseTitleInput.readOnly = true;
            verifiedCourseId = snapshot.docs[0].id;
          }
        }
      } catch(err) {
        console.error(err);
      }
    });

    // ---------- FORM SUBMIT ----------
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const user = auth.currentUser;
      if(!user){
        showAlert('You must be logged in to create an assignment.', 'danger'); return;
      }

      const courseCode = courseCodeInput.value.trim();
      const courseTitle = courseTitleInput.value.trim();
      const assignmentTitle = document.getElementById('assignmentTitle').value.trim();
      const description = document.getElementById('description').value.trim();
      const date = document.getElementById('deadlineDate').value;
      const time = document.getElementById('deadlineTime').value;
      const department = document.getElementById('department').value;
      const level = document.getElementById('level').value;
      const file = document.getElementById('assignmentFile').files[0] || null;

      if(!courseCode || !courseTitle || !assignmentTitle || !description || !date || !time || !department || !level){
        showAlert('Please fill all required fields.', 'danger'); return;
      }

      const deadlineISO = new Date(`${date}T${time}:00`);
      if(isNaN(deadlineISO.getTime())){
        showAlert('Invalid deadline date/time.', 'danger'); return;
      }

      const metadata = {
        courseCode,
        courseTitle,
        assignmentTitle,
        description,
        department,
        level,
        deadline: firebase.firestore.Timestamp.fromDate(deadlineISO),
        fileURL: null,
        filePath: null,
        lecturerId: user.uid,
        courseId: verifiedCourseId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if(file){
          uploadProgress.style.display = 'block';
          uploadProgressBar.style.width = '0%';
          uploadProgressBar.innerText = '0%';

          const sanitized = file.name.replace(/\s+/g, '_');
          const filePath = `assignments/${user.uid}/${Date.now()}_${sanitized}`;

          let fake = 0;
          const fakeTimer = setInterval(() => {
            fake = Math.min(85, fake + Math.round(Math.random()*8));
            uploadProgressBar.style.width = fake + '%';
            uploadProgressBar.innerText = fake + '%';
          }, 300);

          const { data, error } = await supabase.storage.from(BUCKET_ID).upload(filePath, file, { upsert: true });
          clearInterval(fakeTimer);

          if(error){
            uploadProgress.style.display = 'none';
            showAlert('File upload failed: ' + error.message, 'danger'); return;
          }

          const { data: publicData } = supabase.storage.from(BUCKET_ID).getPublicUrl(filePath);
          metadata.fileURL = publicData.publicUrl;
          metadata.filePath = filePath;

          uploadProgressBar.style.width = '100%';
          uploadProgressBar.innerText = '100%';
          await new Promise(res => setTimeout(res, 350));
          uploadProgress.style.display = 'none';
        }

        await db.collection('assignments').add(metadata);
        showAlert('Assignment created successfully!', 'success');
        form.reset();
      } catch(err) {
        console.error(err);
        uploadProgress.style.display = 'none';
        showAlert('Error creating assignment: ' + (err.message || err), 'danger');
      }
    });
  })();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
