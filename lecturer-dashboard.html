<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lecturer Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #f0f7ff, #e0ebff);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
  }
  @keyframes gradientShift {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }

  .navbar { background: rgba(21,101,192,0.85); backdrop-filter: blur(5px); }
  .navbar-brand, .nav-link, .dropdown-toggle { color: white !important; }

  .dashboard-header { text-align: center; margin: 2rem 0; }
  .dashboard-header h2 { font-size: 2rem; font-weight: 700; background: linear-gradient(90deg, #1565c0, #3f51b5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .dashboard-header p { color: #555; opacity: 0.8; }
  .dashboard-header small { display: block; color: #777; margin-top: .25rem; }

  .card {
    border: none; border-radius: 1.2rem;
    background: rgba(255,255,255,0.85); backdrop-filter: blur(10px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
    cursor: pointer; overflow: hidden;
  }
  .card:hover { transform: translateY(-10px) scale(1.03); box-shadow: 0 14px 30px rgba(0,0,0,0.15); background: linear-gradient(135deg, #f5f7ff, #e3f0ff); }
  .card-icon { font-size: 3rem; margin-bottom: 1rem; background: linear-gradient(45deg, #1565c0, #3f51b5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .btn-primary { background: linear-gradient(90deg, #1565c0, #3f51b5); border: none; transition: transform 0.2s, background 0.3s; }
  .btn-primary:hover { transform: translateY(-2px); }
  .btn-primary:active { transform: scale(0.97); }

  #dashboardAvatar { width: 38px; height: 38px; object-fit: cover; border-radius: 50%; border: 2px solid white; margin-right: 0.5rem; }

  #courseSection { max-width: 700px; margin: 2rem auto; background: rgba(255,255,255,0.95); padding: 2rem; border-radius: 1rem; box-shadow: 0 6px 20px rgba(0,0,0,0.15); }

  /* Add to your CSS */
.empty-state {
  text-align: center;
  padding: 2rem;
  color: #6c757d;
}

</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">ðŸ“˜ Lecturer Dashboard</a>
    <div class="dropdown ms-auto d-flex align-items-center">
      <img id="dashboardAvatar" src="school.jpg" alt="avatar">
      <a class="btn btn-outline-light dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Profile</a>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="lecturer-profile.html">Settings</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-danger" id="logoutBtn" href="#">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Header -->
<div class="dashboard-header">
  <h2 class="fw-bold text-primary">Welcome, Lecturer!</h2>
  <p class="text-muted">Manage your courses, materials, and students here.</p>
  <small class="text-secondary">Dashboard / Home</small>
</div>

<!-- Cards -->
<div class="container">
  <div class="row g-4">
    <div class="col-md-6 col-lg-3">
      <div class="card text-center p-4 card-link" data-page="upload-materials.html">
        <div class="card-icon"><i class="bi bi-upload"></i></div>
        <h5 class="card-title">Upload Materials</h5>
        <p class="text-muted">Upload PDFs, PPTs, or Docs for your students.</p>
        <a href="#" class="btn btn-primary">Go</a>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="card text-center p-4 card-link" data-page="announcements.html">
        <div class="card-icon"><i class="bi bi-megaphone"></i></div>
        <h5 class="card-title">Announcements</h5>
        <p class="text-muted">Post important updates for your students.</p>
        <a href="#" class="btn btn-primary">Go</a>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="card text-center p-4 card-link" data-page="assignment_page.html">
        <div class="card-icon"><i class="bi bi-pencil-square"></i></div>
        <h5 class="card-title">Quizzes & Assignments</h5>
        <p class="text-muted">Create and manage quizzes or assignments.</p>
        <a href="#" class="btn btn-primary">Go</a>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="card text-center p-4 card-link" data-page="forum.html">
        <div class="card-icon"><i class="bi bi-chat-dots"></i></div>
        <h5 class="card-title">Q&A Forum</h5>
        <p class="text-muted">Answer questions from your students.</p>
        <a href="#" class="btn btn-primary">Go</a>
      </div>
    </div>
  </div>
</div>

<!-- Course Section -->
<div id="courseSection">
  <h4>Create a Course</h4>
  <form id="createCourseForm">
    <div class="mb-3">
      <label>Course Title</label>
      <input type="text" id="newCourseTitle" class="form-control" placeholder="Intro to Programming" required>
    </div>
    <div class="mb-3">
      <label>Course Code</label>
      <input type="text" id="actualCourseCode" class="form-control" placeholder="e.g. COM216" required>
    </div>
    <button type="submit" class="btn btn-primary">Create Course</button>
  </form>
  <div id="courseCodeDisplay" class="mt-3"></div>

  <div id="lecturerCourses" class="mt-4">
    <h5>Your Courses</h5>
    <div id="coursesContainer" class="list-group"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, addDoc, deleteDoc, serverTimestamp, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
  authDomain: "lecturer-student-project.firebaseapp.com",
  projectId: "lecturer-student-project",
  storageBucket: "lecturer-student-project.appspot.com",
  messagingSenderId: "266517931898",
  appId: "1:266517931898:web:f48b4af12fdc81001058c3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const dashboardAvatar = document.getElementById("dashboardAvatar");
const header = document.querySelector(".dashboard-header h2");
const logoutBtn = document.getElementById("logoutBtn");

// Auth & Role Verification
onAuthStateChanged(auth, async (user) => {
  if (user) {
    try {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        if (data.role !== "lecturer") {
          alert("Access Denied!");
          await signOut(auth);
          window.location.href = "login.html";
        } else {
          header.textContent = `Welcome, ${data.name || "Lecturer"}!`;
          dashboardAvatar.src = data.photoURL || "school.jpg";
        }
      } else window.location.href = "login.html";
    } catch (err) {
      console.error("Error verifying role:", err);
      window.location.href = "login.html";
    }
  } else window.location.href = "login.html";
});

// Logout
logoutBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  try { await signOut(auth); window.location.href = "login.html"; } 
  catch (err) { console.error("Logout failed:", err); }
});

// Card Navigation
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".card-link").forEach(card => {
    card.addEventListener("click", () => {
      const page = card.getAttribute("data-page");
      if (page) window.location.href = page;
    });
  });
});

// Generate Unique Access Code
async function generateAccessCode() {
  let code, exists = true;
  while (exists) {
    code = Math.random().toString(36).substring(2,10).toUpperCase();
    const q = query(collection(db, "courses"), where("accessCode", "==", code));
    const snapshot = await getDocs(q);
    exists = !snapshot.empty;
  }
  return code;
}

// Utility Functions
function sanitizeInput(text) {
  return text.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// Create Course - SINGLE EVENT LISTENER (Fixed the duplicate)
const createCourseForm = document.getElementById("createCourseForm");
const courseCodeDisplay = document.getElementById("courseCodeDisplay");

createCourseForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const submitBtn = createCourseForm.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
  
  try {
    const courseTitle = sanitizeInput(document.getElementById("newCourseTitle").value.trim());
    const actualCode = sanitizeInput(document.getElementById("actualCourseCode").value.trim().toUpperCase());
    
    if (!courseTitle || !actualCode) {
      courseCodeDisplay.innerHTML = `<p class="text-danger">Please fill in all fields.</p>`;
      return;
    }

    const lecturer = auth.currentUser;
    const accessCode = await generateAccessCode();

    await addDoc(collection(db, "courses"), {
      lecturerId: lecturer.uid,
      name: courseTitle,
      courseCode: actualCode,
      accessCode,
      students: [],
      createdAt: serverTimestamp()
    });

    courseCodeDisplay.innerHTML = `<p class="text-success">âœ… Course created! Access code: <strong>${accessCode}</strong></p>`;
    createCourseForm.reset();
    
  } catch (error) {
    console.error("Course creation error:", error);
    courseCodeDisplay.innerHTML = `<p class="text-danger">Error creating course. Please try again.</p>`;
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
});

// Display Courses + Student Count
const coursesContainer = document.getElementById("coursesContainer");

onAuthStateChanged(auth, user => {
  if (!user) return;
  const coursesQuery = query(collection(db, "courses"), where("lecturerId", "==", user.uid));
  
  onSnapshot(coursesQuery, 
    snapshot => {
      coursesContainer.innerHTML = '';
      if (snapshot.empty) {
        coursesContainer.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-journal-plus" style="font-size: 3rem;"></i>
            <p class="mt-3">No courses yet. Create your first course to get started!</p>
          </div>
        `;
        return;
      }

      snapshot.forEach(docSnap => {
        const course = docSnap.data();
        const createdAt = course.createdAt?.toDate().toLocaleDateString() || '-';
        const studentsCount = Array.isArray(course.students) ? course.students.length : 0;

        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap';
        item.innerHTML = `
          <div>
            <strong>${course.name}</strong> 
            <span class="badge bg-secondary ms-2">${course.courseCode}</span>
            <span class="badge bg-info ms-2">Access: ${course.accessCode}</span><br>
            <small class="text-muted">ðŸ‘¥ Students: ${studentsCount} | ðŸ•’ Created: ${createdAt}</small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">Manage</button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item manage-option" data-page="upload-materials.html">Upload Materials</a></li>
                <li><a class="dropdown-item manage-option" data-page="assignment_page.html">Assignments / Quizzes</a></li>
              </ul>
            </div>
            <button class="btn btn-sm btn-outline-danger delete-course">Delete</button>
          </div>
        `;

        // Manage
        item.querySelectorAll('.manage-option').forEach(opt => {
          opt.addEventListener('click', () => {
            const page = opt.getAttribute('data-page');
            const params = new URLSearchParams({
              courseCode: course.courseCode,
              accessCode: course.accessCode,
              courseTitle: course.name
            });
            window.location.href = `${page}?${params.toString()}`;
          });
        });

        // Delete
        item.querySelector('.delete-course').addEventListener('click', async () => {
          if (confirm(`Delete course "${course.name}"? This cannot be undone!`)) {
            await deleteDoc(doc(db, "courses", docSnap.id));
          }
        });

        coursesContainer.appendChild(item);
      });
    },
    error => {
      console.error("Courses loading error:", error);
      coursesContainer.innerHTML = '<p class="text-danger">Error loading courses. Please refresh.</p>';
    }
  );
});
</script>
</body>
</html>