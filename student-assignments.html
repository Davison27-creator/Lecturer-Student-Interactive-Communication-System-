<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Assignments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #198754;
      --secondary-color: #6c757d;
      --success-color: #198754;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #0dcaf0;
    }
    
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Navigation Bar */
    .navbar {
      background: linear-gradient(135deg, #198754, #146c43);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .navbar-nav .nav-link {
      color: rgba(255,255,255,0.9) !important;
      margin: 0 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .navbar-nav .nav-link:hover {
      background: rgba(255,255,255,0.15);
      color: white !important;
    }
    
    .navbar-nav .nav-link.active {
      background: rgba(255,255,255,0.2);
      color: white !important;
    }
    
    .assignment-card {
      border: none;
      border-radius: 16px;
      transition: all 0.3s ease;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      min-height: 240px;
      position: relative;
      overflow: hidden;
    }
    
    .assignment-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--info-color));
    }
    
    .assignment-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    
    .status-badge {
      font-size: 0.8rem;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 500;
    }
    
    .course-badge {
      background: rgba(25, 135, 84, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(25, 135, 84, 0.2);
    }
    
    .deadline-progress {
      height: 4px;
      border-radius: 2px;
      background: #e9ecef;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .deadline-progress-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    
    .skeleton-line {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .empty-state {
      padding: 4rem 2rem;
      text-align: center;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
  </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="student-dashboard.html">
      <i class="bi bi-mortarboard-fill"></i> Student Portal
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="student-dashboard.html">
            <i class="bi bi-house-door"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="student-materials.html">
            <i class="bi bi-folder2-open"></i> Materials
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="student-assignments.html">
            <i class="bi bi-pencil-square"></i> Assignments
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="student-grades.html">
            <i class="bi bi-trophy"></i> Grades
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="student-forum.html">
            <i class="bi bi-chat-dots"></i> Forum
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="text-success fw-bold mb-0">
        <i class="bi bi-journal-text"></i> My Assignments
      </h3>
      <button class="btn btn-outline-success btn-sm" onclick="refreshAssignments()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
      <div class="col-md-6 mb-2">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input type="text" id="searchInput" class="form-control" placeholder="Search assignments...">
        </div>
      </div>
      <div class="col-md-3 mb-2">
        <select id="statusFilter" class="form-select">
          <option value="all">All Status</option>
          <option value="pending">‚è≥ Pending</option>
          <option value="submitted">üì§ Submitted</option>
          <option value="graded">‚úÖ Graded</option>
          <option value="expired">‚ùå Expired</option>
        </select>
      </div>
      <div class="col-md-3 mb-2">
        <select id="courseFilter" class="form-select">
          <option value="all">All Courses</option>
        </select>
      </div>
    </div>

    <div id="assignmentsList" class="row g-4">
      <!-- Skeleton loaders will appear here -->
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
      authDomain: "lecturer-student-project.firebaseapp.com",
      projectId: "lecturer-student-project",
      storageBucket: "lecturer-student-project.appspot.com",
      messagingSenderId: "266517931898",
      appId: "1:266517931898:web:f48b4af12fdc81001058c3"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const assignmentsList = document.getElementById("assignmentsList");
    let allAssignments = [];
    let currentUser = null;

    // Show skeleton loader
    function showSkeletonLoader() {
      assignmentsList.innerHTML = `
        <div class="col-md-6 col-lg-4">
          <div class="card assignment-card p-3">
            <div class="card-body">
              <div class="skeleton-line" style="height: 24px; width: 80%; margin-bottom: 15px;"></div>
              <div class="skeleton-line" style="height: 16px; width: 60%; margin-bottom: 10px;"></div>
              <div class="skeleton-line" style="height: 16px; width: 70%; margin-bottom: 15px;"></div>
              <div class="skeleton-line" style="height: 28px; width: 40%; margin-bottom: 15px;"></div>
              <div class="d-flex gap-2">
                <div class="skeleton-line" style="height: 32px; width: 80px; border-radius: 12px;"></div>
                <div class="skeleton-line" style="height: 32px; width: 100px; border-radius: 12px;"></div>
              </div>
            </div>
          </div>
        </div>
      `.repeat(6);
    }

    // Show empty state
    function showEmptyState(message, icon = "bi-journal-x") {
      assignmentsList.innerHTML = `
        <div class="col-12">
          <div class="empty-state">
            <i class="bi ${icon}"></i>
            <h4 class="text-muted">${message}</h4>
            <p class="text-muted">Check back later for new assignments</p>
          </div>
        </div>
      `;
    }

    // Get status information
    function getStatusInfo(status, grade = null) {
      const statusConfig = {
        "pending": { class: "bg-warning text-dark", icon: "‚è≥", text: "Pending" },
        "submitted": { class: "bg-primary", icon: "üì§", text: "Submitted" },
        "expired": { class: "bg-danger", icon: "‚ùå", text: "Expired" },
        "graded": { class: "bg-success", icon: "‚úÖ", text: `Graded (${grade}%)` }
      };
      return statusConfig[status] || statusConfig["pending"];
    }

    // Refresh assignments
    function refreshAssignments() {
      if (currentUser) {
        showSkeletonLoader();
        loadStudentAssignments(currentUser);
      }
    }

    // Main initialization
    auth.onAuthStateChanged(async (user) => {
      if (!user) return (window.location.href = "login.html");
      
      currentUser = user;
      showSkeletonLoader();
      await loadStudentAssignments(user);
      
      // Set up search and filter listeners
      document.getElementById('searchInput').addEventListener('input', filterAssignments);
      document.getElementById('statusFilter').addEventListener('change', filterAssignments);
      document.getElementById('courseFilter').addEventListener('change', filterAssignments);
    });

    async function loadStudentAssignments(user) {
      try {
        const studentCoursesSnap = await db.collection("studentCourses")
          .where("studentId", "==", user.uid)
          .get();

        if (studentCoursesSnap.empty) {
          showEmptyState("You haven't joined any courses yet", "bi-book");
          return;
        }

        const joinedCourseIds = studentCoursesSnap.docs.map(doc => doc.data().courseId);
        allAssignments = [];

        // Fetch assignments for each joined course
        for (const courseId of joinedCourseIds) {
          const assignmentsSnap = await db.collection("assignments")
            .where("courseId", "==", courseId)
            .orderBy("deadline", "asc")
            .get();

          assignmentsSnap.forEach(doc => {
            allAssignments.push({ id: doc.id, ...doc.data() });
          });
        }

        if (allAssignments.length === 0) {
          showEmptyState("No assignments available for your courses", "bi-journal-text");
          return;
        }

        // Sort assignments by deadline
        allAssignments.sort((a, b) => {
          const aTime = a.deadline?.toDate?.()?.getTime?.() || 0;
          const bTime = b.deadline?.toDate?.()?.getTime?.() || 0;
          return aTime - bTime;
        });

        // Update course filter
        updateCourseFilter(allAssignments);
        
        // Render assignments
        await renderAssignments(allAssignments, user);

      } catch (error) {
        console.error("Error loading assignments:", error);
        showEmptyState("Error loading assignments", "bi-exclamation-triangle");
      }
    }

    function updateCourseFilter(assignments) {
      const courseFilter = document.getElementById('courseFilter');
      const courses = [...new Set(assignments.map(a => a.courseTitle).filter(Boolean))];
      
      courseFilter.innerHTML = '<option value="all">All Courses</option>';
      courses.forEach(course => {
        courseFilter.innerHTML += `<option value="${course}">${course}</option>`;
      });
    }

    async function renderAssignments(assignments, user) {
      assignmentsList.innerHTML = "";

      for (const data of assignments) {
        const deadline = data.deadline?.toDate?.() || null;
        const now = new Date();

        let status = "pending";
        let grade = null;

        // Check if expired
        if (deadline && deadline < now) {
          status = "expired";
        }

        // Check submission status
        const submissionRef = await db
          .collection("assignments")
          .doc(data.id)
          .collection("submissions")
          .doc(user.uid)
          .get();

        if (submissionRef.exists) {
          const subData = submissionRef.data();
          if (subData.grade !== undefined) {
            status = "graded";
            grade = subData.grade;
          } else {
            status = "submitted";
          }
        }

        const statusInfo = getStatusInfo(status, grade);
        const timeLeft = deadline ? getTimeLeft(deadline) : null;

        const col = document.createElement("div");
        col.className = "col-md-6 col-lg-4 assignment-item";
        col.setAttribute('data-status', status);
        col.setAttribute('data-course', data.courseTitle || '');

        col.innerHTML = `
          <div class="card assignment-card p-3 h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge course-badge">${data.courseCode || "Course"}</span>
                <span class="badge ${statusInfo.class} status-badge">
                  ${statusInfo.icon} ${statusInfo.text}
                </span>
              </div>
              
              <h5 class="card-title text-success fw-bold mb-3">${data.assignmentTitle || "Untitled Assignment"}</h5>
              
              <div class="mb-3 flex-grow-1">
                <p class="card-text small text-muted mb-1">
                  <i class="bi bi-calendar-event"></i> 
                  <strong>Deadline:</strong> ${deadline ? deadline.toLocaleString() : "No deadline"}
                </p>
                ${timeLeft ? `<p class="card-text small text-muted mb-2"><i class="bi bi-clock"></i> ${timeLeft}</p>` : ''}
                ${data.maxPoints ? `<p class="card-text small text-muted"><i class="bi bi-star"></i> ${data.maxPoints} points</p>` : ''}
              </div>

              ${deadline && status === 'pending' ? `
                <div class="deadline-progress mb-3">
                  <div class="deadline-progress-bar bg-${getProgressColor(deadline)}" 
                       style="width: ${getDeadlineProgress(deadline)}%"></div>
                </div>
              ` : ''}

              <div class="mt-auto d-flex gap-2 flex-wrap">
                <a href="assignment-details.html?id=${data.id}" class="btn btn-outline-success btn-sm">
                  <i class="bi bi-eye"></i> View
                </a>
                ${data.fileURL ? `
                  <a href="${data.fileURL}" target="_blank" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-download"></i> Download
                  </a>
                ` : ""}
                ${status === 'pending' && deadline && deadline > now ? `
                  <a href="assignment-details.html?id=${data.id}" class="btn btn-success btn-sm">
                    <i class="bi bi-pencil"></i> Submit
                  </a>
                ` : ''}
              </div>
            </div>
          </div>
        `;
        assignmentsList.appendChild(col);
      }
    }

    function getTimeLeft(deadline) {
      const now = new Date();
      const diff = deadline - now;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      
      if (days > 0) return `${days}d ${hours}h left`;
      if (hours > 0) return `${hours}h left`;
      return "Less than 1h left";
    }

    function getDeadlineProgress(deadline) {
      const now = new Date();
      const created = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000)); // Assume created 7 days ago
      const due = deadline;
      const total = due - created;
      const elapsed = now - created;
      
      if (elapsed <= 0) return 0;
      if (elapsed >= total) return 100;
      
      return Math.min(100, Math.max(0, (elapsed / total) * 100));
    }

    function getProgressColor(deadline) {
      const progress = getDeadlineProgress(deadline);
      if (progress < 50) return "success";
      if (progress < 80) return "warning";
      return "danger";
    }

    function filterAssignments() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const courseFilter = document.getElementById('courseFilter').value;
      
      const items = document.querySelectorAll('.assignment-item');
      
      items.forEach(item => {
        const title = item.querySelector('.card-title').textContent.toLowerCase();
        const status = item.getAttribute('data-status');
        const course = item.getAttribute('data-course').toLowerCase();
        
        const matchesSearch = title.includes(searchTerm);
        const matchesStatus = statusFilter === 'all' || status === statusFilter;
        const matchesCourse = courseFilter === 'all' || course === courseFilter.toLowerCase();
        
        item.style.display = (matchesSearch && matchesStatus && matchesCourse) ? 'block' : 'none';
      });
    }
  </script>
</body>
</html>