<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Grades</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f7ff, #f9f9f9);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Navigation Bar */
    .navbar {
      background: linear-gradient(135deg, #1565c0, #0d47a1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .navbar-nav .nav-link {
      color: rgba(255,255,255,0.9) !important;
      margin: 0 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .navbar-nav .nav-link:hover {
      background: rgba(255,255,255,0.15);
      color: white !important;
    }
    
    .navbar-nav .nav-link.active {
      background: rgba(255,255,255,0.2);
      color: white !important;
    }
    
    .container {
      background: #fff;
      margin-top: 3rem;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      max-width: 1000px;
    }
    h2 {
      color: #0d47a1;
      font-weight: 700;
    }
    table {
      margin-top: 1rem;
      border-radius: 12px;
      overflow: hidden;
    }
    th {
      background: #1565c0;
      color: white;
      font-weight: 600;
    }
    .footer {
      margin-top: auto;
      background: #0d47a1;
      color: white;
      text-align: center;
      padding: 0.8rem;
      font-size: 0.9rem;
    }
    .btn-refresh {
      background: #1565c0;
      color: white;
      font-weight: 600;
      transition: 0.3s;
    }
    .btn-refresh:hover {
      background: #0d47a1;
      transform: scale(1.03);
    }
    .status-pass {
      color: #2e7d32;
      font-weight: 600;
    }
    .status-fail {
      color: #c62828;
      font-weight: 600;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .grade-excellent {
      color: #2e7d32;
      font-weight: 700;
    }
    .grade-good {
      color: #7b1fa2;
      font-weight: 700;
    }
    .grade-average {
      color: #f57c00;
      font-weight: 700;
    }
    .grade-poor {
      color: #c62828;
      font-weight: 700;
    }
  </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="student-dashboard.html">
      <i class="bi bi-mortarboard-fill"></i> Student Portal
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="student-dashboard.html">
            <i class="bi bi-house-door"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="student-materials.html">
            <i class="bi bi-folder2-open"></i> Materials
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="student-assignments.html">
            <i class="bi bi-pencil-square"></i> Assignments
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="student-grades.html">
            <i class="bi bi-trophy"></i> Grades
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="student-forum.html">
            <i class="bi bi-chat-dots"></i> Forum
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2><i class="bi bi-mortarboard"></i> My Grades</h2>
      <button class="btn btn-refresh" id="refreshBtn"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
    </div>

    <!-- Summary Section -->
    <div class="row mb-4" id="summarySection" style="display:none;">
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary h-100">
          <div class="card-body text-center">
            <h5>Average Grade</h5>
            <h3 id="averageGrade">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-success h-100">
          <div class="card-body text-center">
            <h5>Passed</h5>
            <h3 id="passedCount">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-info h-100">
          <div class="card-body text-center">
            <h5>Total Courses</h5>
            <h3 id="totalCourses">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning h-100">
          <div class="card-body text-center">
            <h5>Graded Assignments</h5>
            <h3 id="gradedCount">-</h3>
          </div>
        </div>
      </div>
    </div>

    <div id="loading" class="text-center text-primary fw-semibold">
      <div class="spinner-border text-primary" role="status"></div> Loading grades...
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle" id="gradesTable" style="display:none;">
        <thead>
          <tr>
            <th>#</th>
            <th>Course</th>
            <th>Assignment</th>
            <th>Grade</th>
            <th>Feedback</th>
            <th>Status</th>
            <th>File</th>
            <th>Graded At</th>
          </tr>
        </thead>
        <tbody id="gradesBody"></tbody>
      </table>
    </div>
  </div>

  <footer class="footer">Â© 2025 Federal College of Fisheries & Marine Technology</footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
  (async function() {
    const firebaseConfig = {
      apiKey: "AIzaSyDT-7UYGrR_1_2HgosPNo8qGJNAGBCyHJg",
      authDomain: "lecturer-student-project.firebaseapp.com",
      projectId: "lecturer-student-project",
      storageBucket: "lecturer-student-project.appspot.com",
      messagingSenderId: "266517931898",
      appId: "1:266517931898:web:f48b4af12fdc81001058c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const table = document.getElementById("gradesTable");
    const tbody = document.getElementById("gradesBody");
    const loading = document.getElementById("loading");
    const refreshBtn = document.getElementById("refreshBtn");
    const summarySection = document.getElementById("summarySection");
    
    // Summary elements
    const averageGradeEl = document.getElementById("averageGrade");
    const passedCountEl = document.getElementById("passedCount");
    const totalCoursesEl = document.getElementById("totalCourses");
    const gradedCountEl = document.getElementById("gradedCount");

    let isRefreshing = false;

    function getGradeClass(grade) {
      if (grade >= 90) return "grade-excellent";
      if (grade >= 80) return "grade-good";
      if (grade >= 70) return "grade-average";
      return "grade-poor";
    }

    async function fetchGrades(user) {
      loading.style.display = "block";
      table.style.display = "none";
      summarySection.style.display = "none";
      tbody.innerHTML = "";

      try {
        // Step 1: Get all the courses the student joined
        const joinedCoursesSnap = await db.collection("studentCourses")
          .where("studentId", "==", user.uid)
          .get();

        if (joinedCoursesSnap.empty) {
          loading.innerHTML = `
            <div class="alert alert-info d-inline-flex align-items-center" role="alert">
              <i class="bi bi-info-circle-fill me-2"></i>
              You haven't joined any courses yet.
            </div>
          `;
          return;
        }

        const joinedCourseIds = joinedCoursesSnap.docs.map(doc => doc.data().courseId);
        totalCoursesEl.textContent = joinedCourseIds.length;

        // Step 2: Get all submissions by this student
        const submissionsSnap = await db.collection("submissions")
          .where("studentEmail", "==", user.email)
          .orderBy("gradedAt", "desc")
          .get();

        if (submissionsSnap.empty) {
          loading.innerHTML = `
            <div class="alert alert-info d-inline-flex align-items-center" role="alert">
              <i class="bi bi-info-circle-fill me-2"></i>
              No grades available yet.
            </div>
          `;
          return;
        }

        let i = 1;
        let totalGrade = 0;
        let gradedCount = 0;
        let passedCount = 0;
        const gradedAssignments = [];

        for (const doc of submissionsSnap.docs) {
          const data = doc.data();
          const assignmentId = data.assignmentId;
          if (!assignmentId) continue;

          const assignmentDoc = await db.collection("assignments").doc(assignmentId).get();
          if (!assignmentDoc.exists) continue;

          const aData = assignmentDoc.data();

          // â Show only assignments from joined courses
          if (!joinedCourseIds.includes(aData.courseId)) continue;

          // Validate grade
          if (data.grade !== undefined && (data.grade < 0 || data.grade > 100)) {
            console.warn(`Invalid grade for submission ${doc.id}: ${data.grade}`);
            continue;
          }

          const courseName = `${aData.courseCode || ""} â ${aData.courseTitle || "Unknown"}`;
          const assignmentName = aData.title || "Untitled Assignment";
          
          // Calculate statistics for graded assignments
          if (data.grade !== undefined) {
            totalGrade += data.grade;
            gradedCount++;
            if (data.grade >= 50) passedCount++;
            gradedAssignments.push({
              courseName,
              assignmentName,
              grade: data.grade,
              feedback: data.feedback || "â",
              fileURL: data.fileURL,
              gradedAt: data.gradedAt
            });
          }

          const status = data.grade >= 50 ? 
            `<span class="status-pass">Passed</span>` : 
            (data.grade !== undefined ? `<span class="status-fail">Failed</span>` : "Pending");
          
          const gradeDisplay = data.grade !== undefined ? 
            `<span class="${getGradeClass(data.grade)}">${data.grade}%</span>` : 
            "Not graded";
            
          const fileLink = data.fileURL
            ? `<a href="${data.fileURL}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-up-right"></i> View</a>`
            : "N/A";
          const gradedAt = data.gradedAt?.toDate ? data.gradedAt.toDate().toLocaleString() : "Pending";

          const row = `
            <tr>
              <td>${i++}</td>
              <td>${courseName}</td>
              <td>${assignmentName}</td>
              <td>${gradeDisplay}</td>
              <td>${data.feedback || "â"}</td>
              <td>${status}</td>
              <td>${fileLink}</td>
              <td>${gradedAt}</td>
            </tr>
          `;
          tbody.insertAdjacentHTML("beforeend", row);
        }

        // Update summary section
        if (gradedCount > 0) {
          const averageGrade = Math.round(totalGrade / gradedCount);
          averageGradeEl.textContent = `${averageGrade}%`;
          averageGradeEl.className = getGradeClass(averageGrade);
          passedCountEl.textContent = passedCount;
          gradedCountEl.textContent = gradedCount;
          summarySection.style.display = "flex";
        } else {
          averageGradeEl.textContent = "-";
          passedCountEl.textContent = "-";
          gradedCountEl.textContent = "0";
        }

        // Handle empty state
        if (i === 1) {
          loading.innerHTML = `
            <div class="alert alert-info d-inline-flex align-items-center" role="alert">
              <i class="bi bi-info-circle-fill me-2"></i>
              No graded assignments found in your joined courses.
            </div>
          `;
          return;
        }

        loading.style.display = "none";
        table.style.display = "table";
      } catch (error) {
        console.error("Error fetching grades:", error);
        loading.innerHTML = `
          <div class="alert alert-danger d-inline-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Error fetching grades. Please try again.
          </div>
        `;
      }
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("Please log in to access your grades.");
        window.location.href = "login.html";
        return;
      }
      fetchGrades(user);
    });

    refreshBtn.addEventListener("click", async () => {
      if (isRefreshing) return;
      
      isRefreshing = true;
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refreshing...';
      
      const user = auth.currentUser;
      if (user) await fetchGrades(user);
      
      isRefreshing = false;
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh';
    });
  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>